<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Labeling - Google Drive Ïó∞Îèô</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        
        .config-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .config-input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .config-input:focus {
            border-color: #4285f4;
            outline: none;
        }
        
        .auth-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4285f4, #34a853);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
            margin: 5px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        
        .btn-secondary {
            background: #ff9800;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .main-interface {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .progress-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .labeling-area {
            display: flex;
            min-height: 70vh;
        }
        
        .image-container {
            flex: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
            padding: 20px;
        }
        
        .medical-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }
        
        .medical-image:hover {
            transform: scale(1.02);
        }
        
        .controls-panel {
            flex: 1;
            padding: 30px;
            background: white;
            border-left: 1px solid #e0e0e0;
        }
        
        .image-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .label-options {
            margin-bottom: 30px;
        }
        
        .label-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            text-align: left;
        }
        
        .label-button:hover {
            border-color: #4285f4;
            background: #f0f7ff;
            transform: translateX(5px);
        }
        
        .label-button.selected {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .save-btn {
            background: #4CAF50;
            color: white;
        }
        
        .save-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .skip-btn {
            background: #ff9800;
            color: white;
        }
        
        .skip-btn:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }
        
        .folder-selection {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .folder-list {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        
        .folder-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .folder-item:hover {
            border-color: #4285f4;
            transform: translateX(5px);
        }
        
        .folder-item.selected {
            background: #4285f4;
            color: white;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4285f4;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            font-size: 18px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4285f4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            border-color: #c62828;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border-color: #2e7d32;
        }
        
        .info {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #1565c0;
        }
        
        .keyboard-shortcuts {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Medical Image Labeling System</h1>
            <p>Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏å Ïó∞Îèô ÏùòÌïô Ïù¥ÎØ∏ÏßÄ ÎùºÎ≤®ÎßÅ ÌîÑÎ°úÌÜ†ÌÉÄÏûÖ</p>
        </div>
        
        <!-- ÏÑ§Ï†ï ÏÑπÏÖò -->
        <div class="config-section" id="configSection">
            <h3>üîß Íµ¨Í∏Ä API ÏÑ§Ï†ï</h3>
            <p>Î®ºÏ†Ä Íµ¨Í∏Ä ÌÅ¥ÎùºÏö∞Îìú ÏΩòÏÜîÏóêÏÑú API ÌÇ§Î•º Î∞úÍ∏âÎ∞õÏïÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.</p>
            <input type="text" class="config-input" id="clientId" placeholder="Google OAuth Client ID ÏûÖÎ†•">
            <input type="text" class="config-input" id="apiKey" placeholder="Google API Key ÏûÖÎ†•">
            <button class="btn-primary" onclick="saveConfig()">ÏÑ§Ï†ï Ï†ÄÏû•</button>
            <button class="btn-secondary" onclick="showHelp()">ÏÑ§Ï†ï ÎèÑÏõÄÎßê</button>
            <div id="configMessage"></div>
        </div>
        
        <!-- Ïù∏Ï¶ù ÏÑπÏÖò -->
        <div class="auth-section" id="authSection" style="display: none;">
            <h2>üîê Íµ¨Í∏Ä Í≥ÑÏ†ï Ïó∞Í≤∞</h2>
            <p>ÏùòÎ£å Îç∞Ïù¥ÌÑ∞ Ï†ëÍ∑ºÏùÑ ÏúÑÌï¥ Íµ¨Í∏Ä Í≥ÑÏ†ï Ïù∏Ï¶ùÏù¥ ÌïÑÏöîÌï©ÎãàÎã§</p>
            <button class="btn-primary" onclick="signIn()">
                üìÅ Google Drive Ïó∞Í≤∞ÌïòÍ∏∞
            </button>
            <div id="authMessage"></div>
        </div>
        
        <!-- Ìè¥Îçî ÏÑ†ÌÉù ÏÑπÏÖò -->
        <div class="folder-selection" id="folderSection" style="display: none;">
            <h3>üìÇ Ïù¥ÎØ∏ÏßÄ Ìè¥Îçî ÏÑ†ÌÉù</h3>
            <p>ÎùºÎ≤®ÎßÅÌï† ÏùòÌïô Ïù¥ÎØ∏ÏßÄÍ∞Ä Îì§Ïñ¥ÏûàÎäî Ìè¥ÎçîÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
            <button class="btn-primary" onclick="loadFolders()">Ìè¥Îçî Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞</button>
            <div class="folder-list" id="folderList"></div>
            <div id="folderMessage"></div>
        </div>
        
        <!-- Î©îÏù∏ ÎùºÎ≤®ÎßÅ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ -->
        <div class="main-interface" id="mainInterface">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="completedCount">0</div>
                    <div>ÏôÑÎ£å</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalCount">0</div>
                    <div>Ï¥ù Í∞úÏàò</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="accuracyRate">0%</div>
                    <div>ÏßÑÌñâÎ•†</div>
                </div>
            </div>
            
            <div class="progress-section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>ÏßÑÌñâ ÏÉÅÌô©</span>
                    <span id="progressText">0 / 0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div class="labeling-area">
                <div class="image-container">
                    <div class="loading" id="imageLoading">
                        <div class="spinner"></div>
                        Ïù¥ÎØ∏ÏßÄ Î°úÎî© Ï§ë...
                    </div>
                    <img id="medicalImage" class="medical-image" style="display:none;" alt="Medical Image">
                </div>
                
                <div class="controls-panel">
                    <div class="image-info">
                        <h3>ÌòÑÏû¨ Ïù¥ÎØ∏ÏßÄ</h3>
                        <p id="imageFileName">ÌååÏùºÎ™Ö: -</p>
                        <p id="imageIndex">ÏßÑÌñâ: -</p>
                    </div>
                    
                    <div class="label-options">
                        <h3>ÎùºÎ≤® ÏÑ†ÌÉù</h3>
                        <button class="label-button" data-label="normal" onclick="selectLabel('normal')">
                            <span>üîµ Ï†ïÏÉÅ (ÌÇ§: 1)</span>
                        </button>
                        <button class="label-button" data-label="abnormal" onclick="selectLabel('abnormal')">
                            <span>üî¥ ÎπÑÏ†ïÏÉÅ (ÌÇ§: 2)</span>
                        </button>
                        <button class="label-button" data-label="uncertain" onclick="selectLabel('uncertain')">
                            <span>üü° Î∂àÌôïÏã§ (ÌÇ§: 3)</span>
                        </button>
                        <button class="label-button" data-label="artifact" onclick="selectLabel('artifact')">
                            <span>‚ö™ ÏïÑÌã∞Ìå©Ìä∏ (ÌÇ§: 4)</span>
                        </button>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn save-btn" onclick="saveLabel()">Ï†ÄÏû•ÌïòÍ≥† Îã§Ïùå</button>
                        <button class="action-btn skip-btn" onclick="skipImage()">Í±¥ÎÑàÎõ∞Í∏∞</button>
                    </div>
                    
                    <div class="keyboard-shortcuts">
                        <strong>ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§:</strong><br>
                        1: Ï†ïÏÉÅ | 2: ÎπÑÏ†ïÏÉÅ | 3: Î∂àÌôïÏã§ | 4: ÏïÑÌã∞Ìå©Ìä∏<br>
                        Enter: Ï†ÄÏû• | Space: Í±¥ÎÑàÎõ∞Í∏∞
                    </div>
                    
                    <button class="btn-secondary" onclick="exportResults()" style="width: 100%; margin-top: 15px;">
                        üìä Í≤∞Í≥º ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (CSV)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google API Î°úÎìú -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let gapi = null;
        let googleAuth = null;
        let currentUser = null;
        let imageFiles = [];
        let currentImageIndex = 0;
        let selectedLabel = null;
        let labelingResults = [];
        let selectedFolderId = null;
        
        // ÏÑ§Ï†ï Î≥ÄÏàò
        let CLIENT_ID = '';
        let API_KEY = '';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

        // ÏÑ§Ï†ï Ï†ÄÏû•
        function saveConfig() {
            CLIENT_ID = document.getElementById('clientId').value.trim();
            API_KEY = document.getElementById('apiKey').value.trim();
            
            if (!CLIENT_ID || !API_KEY) {
                showMessage('configMessage', 'Client IDÏôÄ API KeyÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }
            
            // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû• (Ïã§Ï†ú Ïö¥ÏòÅÏóêÏÑúÎäî Î≥¥Ïïà Í≥†Î†§ ÌïÑÏöî)
            localStorage.setItem('google_client_id', CLIENT_ID);
            localStorage.setItem('google_api_key', API_KEY);
            
            showMessage('configMessage', 'ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§! Ïù¥Ï†ú Íµ¨Í∏Ä Í≥ÑÏ†ïÏùÑ Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî.', 'success');
            
            // Google API Ï¥àÍ∏∞Ìôî
            initializeGoogleAPI();
        }
        
        // ÎèÑÏõÄÎßê ÌëúÏãú
        function showHelp() {
            const helpText = `
            üìã Íµ¨Í∏Ä API ÏÑ§Ï†ï Î∞©Î≤ï:
            
            1. Google Cloud Console (console.cloud.google.com) Ï†ëÏÜç
            2. ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÎòêÎäî Í∏∞Ï°¥ ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù
            3. API Î∞è ÏÑúÎπÑÏä§ ‚Üí ÎùºÏù¥Î∏åÎü¨Î¶¨ÏóêÏÑú Îã§Ïùå API ÌôúÏÑ±Ìôî:
               - Google Drive API
               - Google Picker API
            4. API Î∞è ÏÑúÎπÑÏä§ ‚Üí ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù Ï†ïÎ≥¥:
               - OAuth 2.0 ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ID ÏÉùÏÑ±
               - API ÌÇ§ ÏÉùÏÑ±
            5. OAuth ÎèôÏùò ÌôîÎ©¥ ÏÑ§Ï†ï
            6. ÏäπÏù∏Îêú JavaScript ÏõêÎ≥∏Ïóê ÌòÑÏû¨ ÎèÑÎ©îÏù∏ Ï∂îÍ∞Ä
            
            ‚ö†Ô∏è ÌÖåÏä§Ìä∏Ïö©Ïù¥ÎØÄÎ°ú Ïã§Ï†ú ÎØºÍ∞ê Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© Ïãú Ï∂îÍ∞Ä Î≥¥Ïïà ÏÑ§Ï†ï ÌïÑÏöî
            `;
            alert(helpText);
        }

        // Google API Ï¥àÍ∏∞Ìôî
        async function initializeGoogleAPI() {
            try {
                await new Promise((resolve) => {
                    gapi.load('auth2:client:picker', resolve);
                });
                
                await gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: [DISCOVERY_DOC],
                    scope: SCOPES
                });
                
                googleAuth = gapi.auth2.getAuthInstance();
                
                showMessage('configMessage', 'Google API Ï¥àÍ∏∞Ìôî ÏôÑÎ£å!', 'success');
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('authSection').style.display = 'block';
                
            } catch (error) {
                showMessage('configMessage', `API Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ${error.message}`, 'error');
            }
        }

        // Î°úÍ∑∏Ïù∏
        async function signIn() {
            try {
                showMessage('authMessage', 'Íµ¨Í∏Ä Í≥ÑÏ†ïÏóê Î°úÍ∑∏Ïù∏ Ï§ë...', 'info');
                
                const authResult = await googleAuth.signIn();
                currentUser = authResult.getBasicProfile();
                
                showMessage('authMessage', `ÌôòÏòÅÌï©ÎãàÎã§, ${currentUser.getName()}Îãò!`, 'success');
                
                setTimeout(() => {
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('folderSection').style.display = 'block';
                }, 1500);
                
            } catch (error) {
                showMessage('authMessage', `Î°úÍ∑∏Ïù∏ Ïã§Ìå®: ${error.message}`, 'error');
            }
        }

        // Ìè¥Îçî Î™©Î°ù Î°úÎìú
        async function loadFolders() {
            try {
                showMessage('folderMessage', 'Ìè¥Îçî Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...', 'info');
                
                const response = await gapi.client.drive.files.list({
                    q: "mimeType='application/vnd.google-apps.folder'",
                    pageSize: 50,
                    fields: 'files(id,name,parents)',
                    orderBy: 'name'
                });
                
                const folders = response.result.files;
                displayFolders(folders);
                
                showMessage('folderMessage', `${folders.length}Í∞úÏùò Ìè¥ÎçîÎ•º Ï∞æÏïòÏäµÎãàÎã§`, 'success');
                
            } catch (error) {
                showMessage('folderMessage', `Ìè¥Îçî Î°úÎìú Ïã§Ìå®: ${error.message}`, 'error');
            }
        }

        // Ìè¥Îçî Î™©Î°ù ÌëúÏãú
        function displayFolders(folders) {
            const folderList = document.getElementById('folderList');
            folderList.innerHTML = '';
            
            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                folderItem.innerHTML = `
                    <strong>üìÅ ${folder.name}</strong>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        ID: ${folder.id}
                    </div>
                `;
                folderItem.onclick = () => selectFolder(folder.id, folder.name, folderItem);
                folderList.appendChild(folderItem);
            });
        }

        // Ìè¥Îçî ÏÑ†ÌÉù
        async function selectFolder(folderId, folderName, folderElement) {
            // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // ÌòÑÏû¨ Ìè¥Îçî ÏÑ†ÌÉù
            folderElement.classList.add('selected');
            selectedFolderId = folderId;
            
            showMessage('folderMessage', `"${folderName}" Ìè¥ÎçîÏóêÏÑú Ïù¥ÎØ∏ÏßÄÎ•º Î°úÎìúÌïòÎäî Ï§ë...`, 'info');
            
            try {
                await loadImagesFromFolder(folderId);
                
                document.getElementById('folderSection').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                
                loadCurrentImage();
                
            } catch (error) {
                showMessage('folderMessage', `Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®: ${error.message}`, 'error');
            }
        }

        // Ìè¥ÎçîÏóêÏÑú Ïù¥ÎØ∏ÏßÄ Î°úÎìú
        async function loadImagesFromFolder(folderId) {
            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and (mimeType contains 'image/' or name contains '.jpg' or name contains '.jpeg' or name contains '.png' or name contains '.gif')`,
                pageSize: 1000,
                fields: 'files(id,name,webViewLink,thumbnailLink,webContentLink)',
                orderBy: 'name'
            });
            
            imageFiles = response.result.files.map(file => ({
                id: file.id,
                name: file.name,
                thumbnailLink: file.thumbnailLink,
                webViewLink: file.webViewLink,
                webContentLink: file.webContentLink
            }));
            
            if (imageFiles.length === 0) {
                throw new Error('ÏÑ†ÌÉùÌïú Ìè¥ÎçîÏóêÏÑú Ïù¥ÎØ∏ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
            }
            
            document.getElementById('totalCount').textContent = imageFiles.length;
        }

        // ÌòÑÏû¨ Ïù¥ÎØ∏ÏßÄ Î°úÎìú
        function loadCurrentImage() {
            if (currentImageIndex >= imageFiles.length) {
                showCompletionMessage();
                return;
            }

            const imageLoading = document.getElementById('imageLoading');
            const medicalImage = document.getElementById('medicalImage');
            
            imageLoading.style.display = 'flex';
            medicalImage.style.display = 'none';
            
            const currentFile = imageFiles[currentImageIndex];
            
            // Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('imageFileName').textContent = `ÌååÏùºÎ™Ö: ${currentFile.name}`;
            document.getElementById('imageIndex').textContent = 
                `ÏßÑÌñâ: ${currentImageIndex + 1} / ${imageFiles.length}`;
            document.getElementById('progressText').textContent = 
                `${currentImageIndex + 1} / ${imageFiles.length}`;
            
            // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
            const progress = ((currentImageIndex) / imageFiles.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Ïù¥ÎØ∏ÏßÄ URL ÏÉùÏÑ± (Ïç∏ÎÑ§Ïùº ÏÇ¨Ïö©)
            let imageUrl = currentFile.thumbnailLink;
            if (imageUrl) {
                // Ïç∏ÎÑ§Ïùº ÌÅ¨Í∏∞ Ï¶ùÍ∞Ä
                imageUrl = imageUrl.replace('=s220', '=s800');
            } else {
                // Ïç∏ÎÑ§ÏùºÏù¥ ÏóÜÏúºÎ©¥ ÏßÅÏ†ë ÎßÅÌÅ¨ ÏÇ¨Ïö© (Í∂åÌïú Î¨∏Ï†ú Í∞ÄÎä•)
                imageUrl = `https://drive.google.com/uc?id=${currentFile.id}`;
            }
            
            // Ïù¥ÎØ∏ÏßÄ Î°úÎìú
            medicalImage.onload = function() {
                imageLoading.style.display = 'none';
                medicalImage.style.display = 'block';
            };
            
            medicalImage.onerror = function() {
                imageLoading.innerHTML = `
                    <div style="text-align: center;">
                        <p>Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®</p>
                        <p style="font-size: 12px; color: #666;">${currentFile.name}</p>
                        <button class="btn-secondary" onclick="skipImage()">Îã§Ïùå Ïù¥ÎØ∏ÏßÄ</button>
                    </div>
                `;
            };
            
            medicalImage.src = imageUrl;
            
            // ÎùºÎ≤® ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
            clearLabelSelection();
        }

        // ÎùºÎ≤® ÏÑ†ÌÉù
        function selectLabel(label) {
            clearLabelSelection();
            selectedLabel = label;
            
            const button = document.querySelector(`[data-label="${label}"]`);
            button.classList.add('selected');
        }

        // ÎùºÎ≤® ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
        function clearLabelSelection() {
            selectedLabel = null;
            document.querySelectorAll('.label-button').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        // ÎùºÎ≤® Ï†ÄÏû•
        function saveLabel() {
            if (!selectedLabel) {
                alert('ÎùºÎ≤®ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            const result = {
                imageId: imageFiles[currentImageIndex].id,
                fileName: imageFiles[currentImageIndex].name,
                label: selectedLabel,
                timestamp: new Date().toISOString(),
                userId: currentUser ? currentUser.getEmail() : 'unknown'
            };

            labelingResults.push(result);
            
            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updateStats();
            
            // Îã§Ïùå Ïù¥ÎØ∏ÏßÄÎ°ú
            nextImage();
        }

        // Ïù¥ÎØ∏ÏßÄ Í±¥ÎÑàÎõ∞Í∏∞
        function skipImage() {
            nextImage();
        }

        // Îã§Ïùå Ïù¥ÎØ∏ÏßÄ
        function nextImage() {
            currentImageIndex++;
            loadCurrentImage();
        }

        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            const completed = labelingResults.length;
            document.getElementById('completedCount').textContent = completed;
            
            const progress = imageFiles.length > 0 ? 
                Math.round((completed / imageFiles.length) * 100) : 0;
            document.getElementById('accuracyRate').textContent = progress + '%';
        }

        // ÏôÑÎ£å Î©îÏãúÏßÄ
        function showCompletionMessage() {
            alert(`üéâ ÎùºÎ≤®ÎßÅ ÏôÑÎ£å!\nÏ¥ù ${labelingResults.length}Í∞ú Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨Îê®`);
        }

        // Í≤∞Í≥º ÎÇ¥Î≥¥ÎÇ¥Í∏∞
        function exportResults() {
            if (labelingResults.length === 0) {
                alert('ÎÇ¥Î≥¥ÎÇº ÎùºÎ≤®ÎßÅ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§');
                return;
            }
            
            // CSV ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
            const csv = convertToCSV(labelingResults);
            
            // ÌååÏùº Îã§Ïö¥Î°úÎìú
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `medical_labeling_results_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // CSV Î≥ÄÌôò
        function convertToCSV(data) {
            const headers = ['Ïù¥ÎØ∏ÏßÄID', 'ÌååÏùºÎ™Ö', 'ÎùºÎ≤®', 'ÏãúÍ∞Ñ', 'ÏÇ¨Ïö©Ïûê'];
            const csvContent = [
                headers.join(','),
                ...data.map(row => [
                    row.imageId,
                    `"${row.fileName}"`,
                    row.label,
                    row.timestamp,
                    row.userId
                ].join(','))
            ].join('\n');
            
            return '\uFEFF' + csvContent; // UTF-8 BOM Ï∂îÍ∞Ä
        }

        // Î©îÏãúÏßÄ ÌëúÏãú
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('mainInterface').style.display === 'none') return;
            
            switch(event.key) {
                case '1':
                    selectLabel('normal');
                    break;
                case '2':
                    selectLabel('abnormal');
                    break;
                case '3':
                    selectLabel('uncertain');
                    break;
                case '4':
                    selectLabel('artifact');
                    break;
                case 'Enter':
                    event.preventDefault();
                    saveLabel();
                    break;
                case ' ':
                    event.preventDefault();
                    skipImage();
                    break;
            }
        });

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï†ÄÏû•Îêú ÏÑ§Ï†ï ÌôïÏù∏
        window.onload = function() {
            const savedClientId = localStorage.getItem('google_client_id');
            const savedApiKey = localStorage.getItem('google_api_key');
            
            if (savedClientId && savedApiKey) {
                document.getElementById('clientId').value = savedClientId;
                document.getElementById('apiKey').value = savedApiKey;
                CLIENT_ID = savedClientId;
                API_KEY = savedApiKey;
                
                showMessage('configMessage', 'Ï†ÄÏû•Îêú ÏÑ§Ï†ïÏùÑ Î∞úÍ≤¨ÌñàÏäµÎãàÎã§. "ÏÑ§Ï†ï Ï†ÄÏû•" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ïó∞Í≤∞ÌïòÏÑ∏Ïöî.', 'info');
            }
        };
    </script>
</body>
</html>