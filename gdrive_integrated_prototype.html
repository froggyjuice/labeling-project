<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Labeling - Google Drive ì—°ë™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        
        .config-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .config-input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .config-input:focus {
            border-color: #4285f4;
            outline: none;
        }
        
        .auth-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4285f4, #34a853);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
            margin: 5px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        
        .btn-secondary {
            background: #ff9800;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .main-interface {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .progress-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .labeling-area {
            display: flex;
            min-height: 70vh;
        }
        
        .image-container {
            flex: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
            padding: 20px;
        }
        
        .medical-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }
        
        .medical-image:hover {
            transform: scale(1.02);
        }
        
        .controls-panel {
            flex: 1;
            padding: 30px;
            background: white;
            border-left: 1px solid #e0e0e0;
        }
        
        .image-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .label-options {
            margin-bottom: 30px;
        }
        
        .label-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            text-align: left;
        }
        
        .label-button:hover {
            border-color: #4285f4;
            background: #f0f7ff;
            transform: translateX(5px);
        }
        
        .label-button.selected {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .save-btn {
            background: #4CAF50;
            color: white;
        }
        
        .save-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .skip-btn {
            background: #ff9800;
            color: white;
        }
        
        .skip-btn:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }
        
        .folder-selection {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .folder-list {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        
        .folder-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .folder-item:hover {
            border-color: #4285f4;
            transform: translateX(5px);
        }
        
        .folder-item.selected {
            background: #4285f4;
            color: white;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4285f4;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            font-size: 18px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4285f4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            border-color: #c62828;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border-color: #2e7d32;
        }
        
        .info {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #1565c0;
        }
        
        .keyboard-shortcuts {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ Medical Image Labeling System</h1>
            <p>êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ì˜í•™ ì´ë¯¸ì§€ ë¼ë²¨ë§ í”„ë¡œí† íƒ€ì…</p>
        </div>
        
        <!-- ì„¤ì • ì„¹ì…˜ -->
        <div class="config-section" id="configSection">
            <h3>ğŸ”§ êµ¬ê¸€ API ì„¤ì •</h3>
            <p>ë¨¼ì € êµ¬ê¸€ í´ë¼ìš°ë“œ ì½˜ì†”ì—ì„œ API í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
            <input type="text" class="config-input" id="clientId" placeholder="Google OAuth Client ID ì…ë ¥">
            <input type="text" class="config-input" id="apiKey" placeholder="Google API Key ì…ë ¥">
            <button class="btn-primary" onclick="saveConfig()">ì„¤ì • ì €ì¥</button>
            <button class="btn-secondary" onclick="showHelp()">ì„¤ì • ë„ì›€ë§</button>
            <div id="configMessage"></div>
        </div>
        
        <!-- ì¸ì¦ ì„¹ì…˜ -->
        <div class="auth-section" id="authSection" style="display: none;">
            <h2>ğŸ” êµ¬ê¸€ ê³„ì • ì—°ê²°</h2>
            <p>ì˜ë£Œ ë°ì´í„° ì ‘ê·¼ì„ ìœ„í•´ êµ¬ê¸€ ê³„ì • ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
            <button class="btn-primary" onclick="signIn()">
                ğŸ“ Google Drive ì—°ê²°í•˜ê¸°
            </button>
            <div id="authMessage"></div>
        </div>
        
        <!-- í´ë” ì„ íƒ ì„¹ì…˜ -->
        <div class="folder-selection" id="folderSection" style="display: none;">
            <h3>ğŸ“‚ ì´ë¯¸ì§€ í´ë” ì„ íƒ</h3>
            <p>ë¼ë²¨ë§í•  ì˜í•™ ì´ë¯¸ì§€ê°€ ë“¤ì–´ìˆëŠ” í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
            <button class="btn-primary" onclick="loadFolders()">í´ë” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <div class="folder-list" id="folderList"></div>
            <div id="folderMessage"></div>
        </div>
        
        <!-- ë©”ì¸ ë¼ë²¨ë§ ì¸í„°í˜ì´ìŠ¤ -->
        <div class="main-interface" id="mainInterface">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="completedCount">0</div>
                    <div>ì™„ë£Œ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalCount">0</div>
                    <div>ì´ ê°œìˆ˜</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="accuracyRate">0%</div>
                    <div>ì§„í–‰ë¥ </div>
                </div>
            </div>
            
            <div class="progress-section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>ì§„í–‰ ìƒí™©</span>
                    <span id="progressText">0 / 0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div class="labeling-area">
                <div class="image-container">
                    <div class="loading" id="imageLoading">
                        <div class="spinner"></div>
                        ì´ë¯¸ì§€ ë¡œë”© ì¤‘...
                    </div>
                    <img id="medicalImage" class="medical-image" style="display:none;" alt="Medical Image">
                </div>
                
                <div class="controls-panel">
                    <div class="image-info">
                        <h3>í˜„ì¬ ì´ë¯¸ì§€</h3>
                        <p id="imageFileName">íŒŒì¼ëª…: -</p>
                        <p id="imageIndex">ì§„í–‰: -</p>
                    </div>
                    
                    <div class="label-options">
                        <h3>ë¼ë²¨ ì„ íƒ</h3>
                        <button class="label-button" data-label="normal" onclick="selectLabel('normal')">
                            <span>ğŸ”µ ì •ìƒ (í‚¤: 1)</span>
                        </button>
                        <button class="label-button" data-label="abnormal" onclick="selectLabel('abnormal')">
                            <span>ğŸ”´ ë¹„ì •ìƒ (í‚¤: 2)</span>
                        </button>
                        <button class="label-button" data-label="uncertain" onclick="selectLabel('uncertain')">
                            <span>ğŸŸ¡ ë¶ˆí™•ì‹¤ (í‚¤: 3)</span>
                        </button>
                        <button class="label-button" data-label="artifact" onclick="selectLabel('artifact')">
                            <span>âšª ì•„í‹°íŒ©íŠ¸ (í‚¤: 4)</span>
                        </button>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn save-btn" onclick="saveLabel()">ì €ì¥í•˜ê³  ë‹¤ìŒ</button>
                        <button class="action-btn skip-btn" onclick="skipImage()">ê±´ë„ˆë›°ê¸°</button>
                    </div>
                    
                    <div class="keyboard-shortcuts">
                        <strong>í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤:</strong><br>
                        1: ì •ìƒ | 2: ë¹„ì •ìƒ | 3: ë¶ˆí™•ì‹¤ | 4: ì•„í‹°íŒ©íŠ¸<br>
                        Enter: ì €ì¥ | Space: ê±´ë„ˆë›°ê¸°
                    </div>
                    
                    <button class="btn-secondary" onclick="exportResults()" style="width: 100%; margin-top: 15px;">
                        ğŸ“Š ê²°ê³¼ ë‚´ë³´ë‚´ê¸° (CSV)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google API ë¡œë“œ -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let gapi = null;
        let googleAuth = null;
        let currentUser = null;
        let imageFiles = [];
        let currentImageIndex = 0;
        let selectedLabel = null;
        let labelingResults = [];
        let selectedFolderId = null;
        
        // ì„¤ì • ë³€ìˆ˜
        let CLIENT_ID = '';
        let API_KEY = '';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

        // ì„¤ì • ì €ì¥
        function saveConfig() {
            CLIENT_ID = document.getElementById('clientId').value.trim();
            API_KEY = document.getElementById('apiKey').value.trim();
            
            if (!CLIENT_ID || !API_KEY) {
                showMessage('configMessage', 'Client IDì™€ API Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ë³´ì•ˆ ê³ ë ¤ í•„ìš”)
            localStorage.setItem('google_client_id', CLIENT_ID);
            localStorage.setItem('google_api_key', API_KEY);
            
            showMessage('configMessage', 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ êµ¬ê¸€ ê³„ì •ì„ ì—°ê²°í•´ì£¼ì„¸ìš”.', 'success');
            
            // Google API ì´ˆê¸°í™”
            initializeGoogleAPI();
        }
        
        // ë„ì›€ë§ í‘œì‹œ
        function showHelp() {
            const helpText = `
            ğŸ“‹ êµ¬ê¸€ API ì„¤ì • ë°©ë²•:
            
            1. Google Cloud Console (console.cloud.google.com) ì ‘ì†
            2. ìƒˆ í”„ë¡œì íŠ¸ ìƒì„± ë˜ëŠ” ê¸°ì¡´ í”„ë¡œì íŠ¸ ì„ íƒ
            3. API ë° ì„œë¹„ìŠ¤ â†’ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ë‹¤ìŒ API í™œì„±í™”:
               - Google Drive API
               - Google Picker API
            4. API ë° ì„œë¹„ìŠ¤ â†’ ì‚¬ìš©ì ì¸ì¦ ì •ë³´:
               - OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID ìƒì„±
               - API í‚¤ ìƒì„±
            5. OAuth ë™ì˜ í™”ë©´ ì„¤ì •
            6. ìŠ¹ì¸ëœ JavaScript ì›ë³¸ì— í˜„ì¬ ë„ë©”ì¸ ì¶”ê°€
            
            âš ï¸ í…ŒìŠ¤íŠ¸ìš©ì´ë¯€ë¡œ ì‹¤ì œ ë¯¼ê° ë°ì´í„° ì‚¬ìš© ì‹œ ì¶”ê°€ ë³´ì•ˆ ì„¤ì • í•„ìš”
            `;
            alert(helpText);
        }

        // Google API ì´ˆê¸°í™”
        async function initializeGoogleAPI() {
            try {
                await new Promise((resolve) => {
                    gapi.load('auth2:client:picker', resolve);
                });
                
                await gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: [DISCOVERY_DOC],
                    scope: SCOPES
                });
                
                googleAuth = gapi.auth2.getAuthInstance();
                
                showMessage('configMessage', 'Google API ì´ˆê¸°í™” ì™„ë£Œ!', 'success');
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('authSection').style.display = 'block';
                
            } catch (error) {
                showMessage('configMessage', `API ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ë¡œê·¸ì¸
        async function signIn() {
            try {
                showMessage('authMessage', 'êµ¬ê¸€ ê³„ì •ì— ë¡œê·¸ì¸ ì¤‘...', 'info');
                
                const authResult = await googleAuth.signIn();
                currentUser = authResult.getBasicProfile();
                
                showMessage('authMessage', `í™˜ì˜í•©ë‹ˆë‹¤, ${currentUser.getName()}ë‹˜!`, 'success');
                
                setTimeout(() => {
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('folderSection').style.display = 'block';
                }, 1500);
                
            } catch (error) {
                showMessage('authMessage', `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í´ë” ëª©ë¡ ë¡œë“œ
        async function loadFolders() {
            try {
                showMessage('folderMessage', 'í´ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
                
                const response = await gapi.client.drive.files.list({
                    q: "mimeType='application/vnd.google-apps.folder'",
                    pageSize: 50,
                    fields: 'files(id,name,parents)',
                    orderBy: 'name'
                });
                
                const folders = response.result.files;
                displayFolders(folders);
                
                showMessage('folderMessage', `${folders.length}ê°œì˜ í´ë”ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤`, 'success');
                
            } catch (error) {
                showMessage('folderMessage', `í´ë” ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í´ë” ëª©ë¡ í‘œì‹œ
        function displayFolders(folders) {
            const folderList = document.getElementById('folderList');
            folderList.innerHTML = '';
            
            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                folderItem.innerHTML = `
                    <strong>ğŸ“ ${folder.name}</strong>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        ID: ${folder.id}
                    </div>
                `;
                folderItem.onclick = () => selectFolder(folder.id, folder.name, folderItem);
                folderList.appendChild(folderItem);
            });
        }

        // í´ë” ì„ íƒ
        async function selectFolder(folderId, folderName, folderElement) {
            // ì´ì „ ì„ íƒ í•´ì œ
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // í˜„ì¬ í´ë” ì„ íƒ
            folderElement.classList.add('selected');
            selectedFolderId = folderId;
            
            showMessage('folderMessage', `"${folderName}" í´ë”ì—ì„œ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...`, 'info');
            
            try {
                await loadImagesFromFolder(folderId);
                
                document.getElementById('folderSection').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                
                loadCurrentImage();
                
            } catch (error) {
                showMessage('folderMessage', `ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í´ë”ì—ì„œ ì´ë¯¸ì§€ ë¡œë“œ
        async function loadImagesFromFolder(folderId) {
            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and (mimeType contains 'image/' or name contains '.jpg' or name contains '.jpeg' or name contains '.png' or name contains '.gif')`,
                pageSize: 1000,
                fields: 'files(id,name,webViewLink,thumbnailLink,webContentLink)',
                orderBy: 'name'
            });
            
            imageFiles = response.result.files.map(file => ({
                id: file.id,
                name: file.name,
                thumbnailLink: file.thumbnailLink,
                webViewLink: file.webViewLink,
                webContentLink: file.webContentLink
            }));
            
            if (imageFiles.length === 0) {
                throw new Error('ì„ íƒí•œ í´ë”ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
            
            document.getElementById('totalCount').textContent = imageFiles.length;
        }

        // í˜„ì¬ ì´ë¯¸ì§€ ë¡œë“œ
        function loadCurrentImage() {
            if (currentImageIndex >= imageFiles.length) {
                showCompletionMessage();
                return;
            }

            const imageLoading = document.getElementById('imageLoading');
            const medicalImage = document.getElementById('medicalImage');
            
            imageLoading.style.display = 'flex';
            medicalImage.style.display = 'none';
            
            const currentFile = imageFiles[currentImageIndex];
            
            // ì´ë¯¸ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('imageFileName').textContent = `íŒŒì¼ëª…: ${currentFile.name}`;
            document.getElementById('imageIndex').textContent = 
                `ì§„í–‰: ${currentImageIndex + 1} / ${imageFiles.length}`;
            document.getElementById('progressText').textContent = 
                `${currentImageIndex + 1} / ${imageFiles.length}`;
            
            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            const progress = ((currentImageIndex) / imageFiles.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // ì´ë¯¸ì§€ URL ìƒì„± (ì¸ë„¤ì¼ ì‚¬ìš©)
            let imageUrl = currentFile.thumbnailLink;
            if (imageUrl) {
                // ì¸ë„¤ì¼ í¬ê¸° ì¦ê°€
                imageUrl = imageUrl.replace('=s220', '=s800');
            } else {
                // ì¸ë„¤ì¼ì´ ì—†ìœ¼ë©´ ì§ì ‘ ë§í¬ ì‚¬ìš© (ê¶Œí•œ ë¬¸ì œ ê°€ëŠ¥)
                imageUrl = `https://drive.google.com/uc?id=${currentFile.id}`;
            }
            
            // ì´ë¯¸ì§€ ë¡œë“œ
            medicalImage.onload = function() {
                imageLoading.style.display = 'none';
                medicalImage.style.display = 'block';
            };
            
            medicalImage.onerror = function() {
                imageLoading.innerHTML = `
                    <div style="text-align: center;">
                        <p>ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨</p>
                        <p style="font-size: 12px; color: #666;">${currentFile.name}</p>
                        <button class="btn-secondary" onclick="skipImage()">ë‹¤ìŒ ì´ë¯¸ì§€</button>
                    </div>
                `;
            };
            
            medicalImage.src = imageUrl;
            
            // ë¼ë²¨ ì„ íƒ ì´ˆê¸°í™”
            clearLabelSelection();
        }

        // ë¼ë²¨ ì„ íƒ
        function selectLabel(label) {
            clearLabelSelection();
            selectedLabel = label;
            
            const button = document.querySelector(`[data-label="${label}"]`);
            button.classList.add('selected');
        }

        // ë¼ë²¨ ì„ íƒ ì´ˆê¸°í™”
        function clearLabelSelection() {
            selectedLabel = null;
            document.querySelectorAll('.label-button').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        // ë¼ë²¨ ì €ì¥
        function saveLabel() {
            if (!selectedLabel) {
                alert('ë¼ë²¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const result = {
                imageId: imageFiles[currentImageIndex].id,
                fileName: imageFiles[currentImageIndex].name,
                label: selectedLabel,
                timestamp: new Date().toISOString(),
                userId: currentUser ? currentUser.getEmail() : 'unknown'
            };

            labelingResults.push(result);
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            updateStats();
            
            // ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ
            nextImage();
        }

        // ì´ë¯¸ì§€ ê±´ë„ˆë›°ê¸°
        function skipImage() {
            nextImage();
        }

        // ë‹¤ìŒ ì´ë¯¸ì§€
        function nextImage() {
            currentImageIndex++;
            loadCurrentImage();
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const completed = labelingResults.length;
            document.getElementById('completedCount').textContent = completed;
            
            const progress = imageFiles.length > 0 ? 
                Math.round((completed / imageFiles.length) * 100) : 0;
            document.getElementById('accuracyRate').textContent = progress + '%';
        }

        // ì™„ë£Œ ë©”ì‹œì§€
        function showCompletionMessage() {
            alert(`ğŸ‰ ë¼ë²¨ë§ ì™„ë£Œ!\nì´ ${labelingResults.length}ê°œ ì´ë¯¸ì§€ ì²˜ë¦¬ë¨`);
        }

        // ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
        function exportResults() {
            if (labelingResults.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë¼ë²¨ë§ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // CSV í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const csv = convertToCSV(labelingResults);
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `medical_labeling_results_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // CSV ë³€í™˜
        function convertToCSV(data) {
            const headers = ['ì´ë¯¸ì§€ID', 'íŒŒì¼ëª…', 'ë¼ë²¨', 'ì‹œê°„', 'ì‚¬ìš©ì'];
            const csvContent = [
                headers.join(','),
                ...data.map(row => [
                    row.imageId,
                    `"${row.fileName}"`,
                    row.label,
                    row.timestamp,
                    row.userId
                ].join(','))
            ].join('\n');
            
            return '\uFEFF' + csvContent; // UTF-8 BOM ì¶”ê°€
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('mainInterface').style.display === 'none') return;
            
            switch(event.key) {
                case '1':
                    selectLabel('normal');
                    break;
                case '2':
                    selectLabel('abnormal');
                    break;
                case '3':
                    selectLabel('uncertain');
                    break;
                case '4':
                    selectLabel('artifact');
                    break;
                case 'Enter':
                    event.preventDefault();
                    saveLabel();
                    break;
                case ' ':
                    event.preventDefault();
                    skipImage();
                    break;
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì„¤ì • í™•ì¸
        window.onload = function() {
            const savedClientId = localStorage.getItem('google_client_id');
            const savedApiKey = localStorage.getItem('google_api_key');
            
            if (savedClientId && savedApiKey) {
                document.getElementById('clientId').value = savedClientId;
                document.getElementById('apiKey').value = savedApiKey;
                CLIENT_ID = savedClientId;
                API_KEY = savedApiKey;
                
                showMessage('configMessage', 'ì €ì¥ëœ ì„¤ì •ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. "ì„¤ì • ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—°ê²°í•˜ì„¸ìš”.', 'info');
            }
        };
    </script>
</body>
</html>