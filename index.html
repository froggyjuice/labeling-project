<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë¯¸ì§€ ë¼ë²¨ë§ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .screen.active {
            display: block;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-screen {
            text-align: center;
            padding: 60px 40px;
        }

        .login-screen h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -moz-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            -moz-text-fill-color: transparent;
        }

        .user-code-input {
            width: 100%;
            max-width: 400px;
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            margin: 20px 0;
            transition: border-color 0.3s;
        }

        .user-code-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        /* ëŒ€ì‹œë³´ë“œ */
        .dashboard {
            padding: 40px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ í—¤ë” */
        .nav-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -moz-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            -moz-text-fill-color: transparent;
            cursor: pointer;
            user-select: none;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 0.9rem;
        }

        .breadcrumb-item {
            cursor: pointer;
            transition: color 0.2s;
        }

        .breadcrumb-item:hover {
            color: #667eea;
        }

        .breadcrumb-item.active {
            color: #333;
            font-weight: 500;
        }

        .breadcrumb-separator {
            color: #ccc;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .home-btn {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .home-btn:hover {
            background: #667eea;
            color: white;
        }

        .quick-stats {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #667eea;
        }

        .progress-section {
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .batch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .batch-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .batch-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .batch-card.completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
        }

        /* ì‘ì—… í™”ë©´ */
        .labeling-screen {
            display: flex;
            height: 100vh;
            max-height: 100vh;
        }

        .image-section {
            flex: 1;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .image-container {
            max-width: 100%;
            max-height: 70vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .current-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .image-info {
            margin-top: 20px;
            text-align: center;
            color: #666;
        }

        .controls-section {
            width: 350px;
            background: white;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-left: 2px solid #f0f0f0;
        }

        .label-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .label-btn {
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 1.1rem;
            transition: all 0.2s;
            position: relative;
        }

        .label-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .label-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .label-btn .hotkey {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .nav-btn.prev {
            background: #6c757d;
            color: white;
        }

        .nav-btn.next {
            background: #28a745;
            color: white;
        }

        .nav-btn.skip {
            background: #ffc107;
            color: #212529;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .progress-info {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .hotkey-guide {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #666;
        }

        .hotkey-guide h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .labeling-screen {
                flex-direction: column;
                height: auto;
            }
            
            .controls-section {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ë¡œê·¸ì¸ í™”ë©´ -->
        <div id="loginScreen" class="screen active">
            <div class="login-screen">
                <h1>ì´ë¯¸ì§€ ë¼ë²¨ë§ ì‹œìŠ¤í…œ</h1>
                <p>ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                <div style="display:flex; gap:20px; justify-content:center; margin-bottom:30px;">
                    <button onclick="showUserLogin()" class="btn" style="flex:1;">ì‚¬ìš©ì ëª¨ë“œ</button>
                    <button onclick="showAdminLogin()" class="btn" style="flex:1; background:linear-gradient(135deg,#ff9800,#f44336);">ê´€ë¦¬ì ëª¨ë“œ</button>
                </div>
                <div id="userLoginSection" style="display:none;">
                    <input type="text" id="userCodeInput" class="user-code-input" placeholder="ì‚¬ìš©ì ì½”ë“œ ì…ë ¥">
                    <br>
                    <button onclick="startLogin()" class="btn">ë¡œê·¸ì¸ ì‹œì‘</button>
                </div>
            </div>
        </div>

        <!-- ê´€ë¦¬ì ì¸ì¦ í™”ë©´ -->
        <div id="adminAuthScreen" class="screen">
            <div class="login-screen">
                <h1>ê´€ë¦¬ì ì¸ì¦</h1>
                <input type="password" id="adminPasswordInput" class="user-code-input" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                <br>
                <button onclick="adminLogin()" class="btn">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
                <br><br>
                <button onclick="backToModeSelect()" class="home-btn">â† ëª¨ë“œ ì„ íƒìœ¼ë¡œ</button>
            </div>
        </div>

        <!-- ë¡œë”© í™”ë©´ -->
        <div id="loadingScreen" class="screen">
            <div class="loading">
                <div class="spinner"></div>
                <p>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì¤‘...</p>
            </div>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ -->
        <div id="dashboardScreen" class="screen">
            <!-- ë„¤ë¹„ê²Œì´ì…˜ í—¤ë” -->
            <div class="nav-header">
                <div class="nav-left">
                    <div class="logo" onclick="goHome()">ğŸ“Š ImageLabel</div>
                    <div class="breadcrumb">
                        <span class="breadcrumb-item active">ëŒ€ì‹œë³´ë“œ</span>
                    </div>
                </div>
                <div class="nav-right">
                    <div class="quick-stats">
                        <div class="stat-item">
                            <span>ğŸ“ˆ</span>
                            <span id="quickProgress">0% ì™„ë£Œ</span>
                        </div>
                    </div>
                    <div class="user-info">
                        <img id="userAvatar" class="user-avatar" src="" alt="User">
                        <div>
                            <div id="userName">ì‚¬ìš©ì</div>
                            <div id="userEmail" style="font-size: 0.8rem; color: #666;">email@example.com</div>
                        </div>
                    </div>
                    <button onclick="logout()" class="btn" style="padding: 8px 16px; font-size: 0.9rem;">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>

            <div class="dashboard">
                <div class="progress-section">
                    <h3>ì „ì²´ ì§„í–‰ë¥ </h3>
                    <div class="progress-bar">
                        <div id="overallProgress" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <p id="progressText">0 / 0 ì´ë¯¸ì§€ ì™„ë£Œ</p>
                </div>

                <h3>ì‘ì—… ë°°ì¹˜</h3>
                <div id="batchGrid" class="batch-grid">
                    <!-- ë°°ì¹˜ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>

        <!-- ë¼ë²¨ë§ í™”ë©´ -->
        <div id="labelingScreen" class="screen">
            <!-- ë„¤ë¹„ê²Œì´ì…˜ í—¤ë” -->
            <div class="nav-header">
                <div class="nav-left">
                    <div class="logo" onclick="goHome()">ğŸ“Š ImageLabel</div>
                    <div class="breadcrumb">
                        <span class="breadcrumb-item" onclick="backToDashboard()">ëŒ€ì‹œë³´ë“œ</span>
                        <span class="breadcrumb-separator">></span>
                        <span class="breadcrumb-item active" id="breadcrumbBatch">ë°°ì¹˜ 1</span>
                    </div>
                </div>
                <div class="nav-right">
                    <div class="quick-stats">
                        <div class="stat-item">
                            <span>ğŸ·ï¸</span>
                            <span id="quickImageProgress">1 / 100</span>
                        </div>
                    </div>
                    <button onclick="goHome()" class="home-btn">
                        ğŸ  í™ˆ
                    </button>
                    <button onclick="backToDashboard()" class="btn" style="padding: 8px 16px; font-size: 0.9rem;">ëŒ€ì‹œë³´ë“œ</button>
                </div>
            </div>

            <div class="labeling-screen">
                <div class="image-section">
                    <div class="image-container">
                        <img id="currentImage" class="current-image" src="" alt="Label this image">
                    </div>
                    <div class="image-info">
                        <p id="imageFileName">ì´ë¯¸ì§€ë¥¼ ë¡œë”© ì¤‘...</p>
                    </div>
                </div>

                <div class="controls-section">
                    <div class="progress-info">
                        <h3 id="batchTitle">ë°°ì¹˜ 1</h3>
                        <p id="imageProgress">ì´ë¯¸ì§€ 1 / 100</p>
                    </div>

                    <div class="label-options">
                        <button class="label-btn" data-label="positive" onclick="selectLabel('positive')">
                            ê¸ì •ì  <span class="hotkey">1</span>
                        </button>
                        <button class="label-btn" data-label="negative" onclick="selectLabel('negative')">
                            ë¶€ì •ì  <span class="hotkey">2</span>
                        </button>
                        <button class="label-btn" data-label="neutral" onclick="selectLabel('neutral')">
                            ì¤‘ë¦½ì  <span class="hotkey">3</span>
                        </button>
                    </div>

                    <div class="action-buttons">
                        <button class="nav-btn prev" onclick="previousImage()">ì´ì „</button>
                        <button class="nav-btn skip" onclick="skipImage()">ë³´ë¥˜</button>
                        <button class="nav-btn next" onclick="nextImage()">ë‹¤ìŒ</button>
                    </div>

                    <button class="btn" style="width:100%;margin-top:5px;" onclick="saveProgressAndNotify()">ì €ì¥í•˜ê¸°</button>

                    <div class="hotkey-guide">
                        <h4>í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</h4>
                        <p>1, 2, 3: ë¼ë²¨ ì„ íƒ</p>
                        <p>Space: ë³´ë¥˜</p>
                        <p>Enter / â†’: ë‹¤ìŒ ì´ë¯¸ì§€</p>
                        <p>â†: ì´ì „ ì´ë¯¸ì§€</p>
                        <p>Esc: ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
        <div id="adminDashboardScreen" class="screen">
            <div class="dashboard">
                <h2>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
                <button onclick="backToModeSelect()" class="home-btn">â† ëª¨ë“œ ì„ íƒìœ¼ë¡œ</button>
                <div id="adminResultsTable" style="margin-top:30px;"></div>
            </div>
        </div>
    </div>

    <script>
        // ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ ê´€ë¦¬
        class AppState {
            constructor() {
                this.currentScreen = 'login';
                this.user = null;
                this.batches = [];
                this.currentBatch = null;
                this.currentImageIndex = 0;
                this.labels = {};
                this.googleAuth = null;
                this.lastSavedLabels = {};
            }

            // í™”ë©´ ì „í™˜
            switchScreen(screenName) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenName + 'Screen').classList.add('active');
                this.currentScreen = screenName;
            }

            // ì‚¬ìš©ì ì •ë³´ ì„¤ì •
            setUser(userInfo) {
                this.user = userInfo;
                document.getElementById('userName').textContent = userInfo.name;
                document.getElementById('userEmail').textContent = userInfo.email;
                document.getElementById('userAvatar').src = userInfo.picture;
            }

            // ë°°ì¹˜ ë°ì´í„° ì„¤ì •
            setBatches(batches) {
                this.batches = batches;
                this.renderBatches();
                this.updateOverallProgress();
            }

            // ë°°ì¹˜ ë Œë”ë§
            renderBatches() {
                const grid = document.getElementById('batchGrid');
                grid.innerHTML = '';
                
                this.batches.forEach((batch, index) => {
                    const card = document.createElement('div');
                    card.className = `batch-card ${batch.completed ? 'completed' : ''}`;
                    card.innerHTML = `
                        <h4>ë°°ì¹˜ ${index + 1}</h4>
                        <p>${batch.completed ? batch.images.length : batch.progress} / ${batch.images.length} ì™„ë£Œ</p>
                        <p>${batch.completed ? 'ì™„ë£Œë¨' : 'ì§„í–‰ ì¤‘'}</p>
                    `;
                    card.onclick = () => this.startBatch(index);
                    grid.appendChild(card);
                });
            }

            // ì „ì²´ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            updateOverallProgress() {
                const totalImages = this.batches.reduce((acc, batch) => acc + batch.images.length, 0);
                const completedImages = this.batches.reduce((acc, batch) => 
                    acc + (batch.completed ? batch.images.length : batch.progress), 0);
                
                const percentage = totalImages > 0 ? (completedImages / totalImages) * 100 : 0;
                
                document.getElementById('overallProgress').style.width = `${percentage}%`;
                document.getElementById('progressText').textContent = `${completedImages} / ${totalImages} ì´ë¯¸ì§€ ì™„ë£Œ`;
            }

            // ë°°ì¹˜ ì‹œì‘
            startBatch(batchIndex) {
                this.currentBatch = this.batches[batchIndex];
                this.currentBatchIndex = batchIndex;
                this.currentImageIndex = this.currentBatch.progress || 0;
                
                document.getElementById('batchTitle').textContent = `ë°°ì¹˜ ${batchIndex + 1}`;
                document.getElementById('breadcrumbBatch').textContent = `ë°°ì¹˜ ${batchIndex + 1}`;
                this.loadCurrentImage();
                this.switchScreen('labeling');
            }

            // í˜„ì¬ ì´ë¯¸ì§€ ë¡œë“œ
            loadCurrentImage() {
                if (!this.currentBatch || this.currentImageIndex >= this.currentBatch.images.length) {
                    return;
                }

                const image = this.currentBatch.images[this.currentImageIndex];
                document.getElementById('currentImage').src = image.url;
                document.getElementById('imageFileName').textContent = image.name;
                document.getElementById('imageProgress').textContent = 
                    `ì´ë¯¸ì§€ ${this.currentImageIndex + 1} / ${this.currentBatch.images.length}`;

                // ì´ì „ì— ì„ íƒëœ ë¼ë²¨ì´ ìˆë‹¤ë©´ í‘œì‹œ
                this.showCurrentLabel();
            }

            // í˜„ì¬ ë¼ë²¨ í‘œì‹œ (ë‹¤ì¤‘ ì„ íƒ)
            showCurrentLabel() {
                const imageId = this.getCurrentImageId();
                const currentLabels = this.labels[imageId] || [];
                document.querySelectorAll('.label-btn').forEach(btn => {
                    btn.classList.remove('selected');
                    if (currentLabels.includes(btn.dataset.label)) {
                        btn.classList.add('selected');
                    }
                });
            }

            // í˜„ì¬ ì´ë¯¸ì§€ ID ê°€ì ¸ì˜¤ê¸°
            getCurrentImageId() {
                if (!this.currentBatch || this.currentImageIndex >= this.currentBatch.images.length) {
                    return null;
                }
                return this.currentBatch.images[this.currentImageIndex].id;
            }

            // ë¼ë²¨ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ/í•´ì œ í† ê¸€)
            selectLabel(label) {
                const imageId = this.getCurrentImageId();
                if (imageId) {
                    if (!Array.isArray(this.labels[imageId])) {
                        this.labels[imageId] = [];
                    }
                    const idx = this.labels[imageId].indexOf(label);
                    if (idx === -1) {
                        this.labels[imageId].push(label);
                    } else {
                        this.labels[imageId].splice(idx, 1);
                    }
                    this.showCurrentLabel();
                    this.saveProgress();
                }
            }

            // ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ì´ë™ (ë‹¤ì¤‘ ì„ íƒ ì²´í¬)
            nextImage() {
                const imageId = this.getCurrentImageId();
                if (!this.labels[imageId] || this.labels[imageId].length === 0) {
                    alert('ë¼ë²¨ì„ í•˜ë‚˜ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”!');
                    return;
                }
                if (this.currentImageIndex < this.currentBatch.images.length - 1) {
                    this.currentImageIndex++;
                    this.loadCurrentImage();
                } else {
                    // ë°°ì¹˜ ì™„ë£Œ
                    this.currentBatch.completed = true;
                    this.currentBatch.progress = this.currentBatch.images.length;
                    alert('ë°°ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    this.switchScreen('dashboard');
                    this.updateOverallProgress();
                    this.renderBatches();
                }
            }

            // ì´ì „ ì´ë¯¸ì§€ë¡œ ì´ë™
            previousImage() {
                if (this.currentImageIndex > 0) {
                    this.currentImageIndex--;
                    this.loadCurrentImage();
                }
            }

            // ì´ë¯¸ì§€ ê±´ë„ˆë›°ê¸° (ë¼ë²¨ ì „ì²´ í•´ì œ í›„ ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ì´ë™)
            skipImage() {
                const imageId = this.getCurrentImageId();
                if (imageId) {
                    delete this.labels[imageId];
                    this.showCurrentLabel();
                }
                // ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ì´ë™
                if (this.currentImageIndex < this.currentBatch.images.length - 1) {
                    this.currentImageIndex++;
                    this.loadCurrentImage();
                } else {
                    // ë°°ì¹˜ ì™„ë£Œ
                    this.currentBatch.completed = true;
                    this.currentBatch.progress = this.currentBatch.images.length;
                    alert('ë°°ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    this.switchScreen('dashboard');
                    this.updateOverallProgress();
                    this.renderBatches();
                }
            }

            // ì§„í–‰ë¥  ì €ì¥ (ì‹¤ì œ API ì—°ë™)
            async saveProgress() {
                if (this.currentBatch && this.user) {
                    this.currentBatch.progress = Math.max(this.currentImageIndex, this.currentBatch.progress || 0);
                    const saveData = {
                        userId: this.user.userId,
                        batchId: this.currentBatch.id,
                        labels: this.labels,
                        currentIndex: this.currentImageIndex,
                        timestamp: new Date().toISOString()
                    };
                    try {
                        const response = await fetch('/api/labeling/save-progress', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(saveData)
                        }).catch(() => ({ ok: false }));
                        // ì €ì¥ ì„±ê³µ ì‹œ ë¼ë²¨ ìƒíƒœ ë°±ì—…
                        this.lastSavedLabels = JSON.parse(JSON.stringify(this.labels));
                        if (response.ok) {
                            console.log('Progress saved to server');
                        } else {
                            console.log('Failed to save to server, using local storage');
                        }
                        console.log('Progress saved locally:', saveData);
                    } catch (error) {
                        console.error('Save error:', error);
                        console.log('Saved locally due to error');
                        // ì €ì¥ ì‹¤íŒ¨í•´ë„ ë¼ë²¨ ìƒíƒœ ë°±ì—…
                        this.lastSavedLabels = JSON.parse(JSON.stringify(this.labels));
                    }
                }
            }

            // ì§„í–‰ë¥  ë¡œë“œ (ì‹¤ì œ API ì—°ë™)
            async loadProgress(batchId) {
                if (!this.user) return;

                try {
                    const response = await fetch(`/api/labeling/load-progress/${this.user.userId}/${batchId}`)
                        .catch(() => ({ ok: false }));

                    if (response.ok) {
                        const data = await response.json();
                        this.labels = { ...this.labels, ...data.labels };
                        return data.currentIndex || 0;
                    }
                } catch (error) {
                    console.error('Load progress error:', error);
                }
                
                return 0; // ê¸°ë³¸ê°’
            }

            // ë¼ë²¨ ë³€ê²½ ì—¬ë¶€ í™•ì¸
            isLabelChanged() {
                return JSON.stringify(this.labels) !== JSON.stringify(this.lastSavedLabels);
            }
        }

        // ì „ì—­ ìƒíƒœ ê°ì²´
        const appState = new AppState();

        // Google OAuth ì„¤ì •
        const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID'; // ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ IDë¡œ êµì²´ í•„ìš”

        // ë¡œê·¸ì¸ ì‹œì‘
        async function startLogin() {
            const userCode = document.getElementById('userCodeInput').value.trim();
            if (!userCode) {
                alert('ì‚¬ìš©ì ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            appState.switchScreen('loading');

            try {
                // ì‹¤ì œ Google OAuth êµ¬í˜„ì´ í•„ìš”í•œ ë¶€ë¶„
                // í˜„ì¬ëŠ” ë°ëª¨ìš© ë°ì´í„°ë¡œ ëŒ€ì²´
                await simulateGoogleAuth(userCode);
            } catch (error) {
                console.error('Login failed:', error);
                alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                appState.switchScreen('login');
            }
        }

        // ì‹¤ì œ Google ì¸ì¦ ë° API ì—°ë™
        async function simulateGoogleAuth(userCode) {
            try {
                // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ ì§„í–‰ë©ë‹ˆë‹¤:
                /*
                // 1. Google OAuth ì´ˆê¸°í™”
                const authManager = new GoogleAuthManager();
                await authManager.initialize();
                
                // 2. ì‚¬ìš©ì ë¡œê·¸ì¸
                const userInfo = await authManager.signIn(userCode);
                appState.setUser(userInfo);
                
                // 3. ì‚¬ìš©ìë³„ ë°°ì¹˜ ë°ì´í„° ë¡œë“œ
                const response = await fetch(`/api/labeling/batches/${userInfo.userId}`);
                const batches = await response.json();
                
                // 4. ê° ë°°ì¹˜ì˜ ì§„í–‰ë¥  ë³µì›
                for (let batch of batches) {
                    const progressResponse = await fetch(`/api/labeling/load-progress/${userInfo.userId}/${batch.id}`);
                    const progress = await progressResponse.json();
                    batch.progress = progress.currentIndex;
                    batch.completed = progress.currentIndex >= batch.images.length;
                }
                
                appState.setBatches(batches);
                */

                // í˜„ì¬ëŠ” ë°ëª¨ìš© ì‹œë®¬ë ˆì´ì…˜
                await new Promise(resolve => setTimeout(resolve, 2000));

                // API ê²€ì¦ ì‹œë®¬ë ˆì´ì…˜
                const validationResponse = await fetch('/api/validate-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userCode: userCode,
                        email: 'demo@example.com'
                    })
                }).catch(() => ({ ok: false })); // ë°ëª¨ì—ì„œëŠ” ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰

                // ì‚¬ìš©ì ì •ë³´ ì„¤ì • (ë°ëª¨ìš©)
                appState.setUser({
                    name: 'ê¹€ê°œë°œì',
                    email: 'developer@example.com',
                    picture: 'https://via.placeholder.com/50',
                    userId: 'demo_user_id'
                });

                // ìƒ˜í”Œ ë°°ì¹˜ ë°ì´í„° ìƒì„± (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ê°€ì ¸ì˜´)
                const sampleBatches = await generateSampleBatches();
                appState.setBatches(sampleBatches);
                appState.switchScreen('dashboard');

            } catch (error) {
                console.error('ì¸ì¦ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        // ìƒ˜í”Œ ë°°ì¹˜ ìƒì„± í•¨ìˆ˜
        async function generateSampleBatches() {
            const sampleBatches = [];
            for (let i = 0; i < 5; i++) {
                const images = [];
                for (let j = 0; j < 100; j++) {
                    images.push({
                        id: `batch_${i}_image_${j}`,
                        name: `ì´ë¯¸ì§€_${i + 1}_${j + 1}.jpg`,
                        url: `https://picsum.photos/600/400?random=${i * 100 + j}`,
                        driveFileId: `drive_file_${i}_${j}`
                    });
                }
                
                sampleBatches.push({
                    id: `batch_${i}`,
                    images: images,
                    progress: i === 0 ? 25 : 0,
                    completed: false
                });
            }
            return sampleBatches;
        }

        // ë¼ë²¨ ì„ íƒ
        function selectLabel(label) {
            appState.selectLabel(label);
        }

        // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
        function nextImage() {
            appState.nextImage();
        }

        function previousImage() {
            appState.previousImage();
        }

        function skipImage() {
            appState.skipImage();
        }

        function backToDashboard() {
            // ë¼ë²¨ ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ê²½ê³ 
            if (appState.currentScreen === 'labeling' && appState.isLabelChanged()) {
                if (!confirm('ì €ì¥ë˜ì§€ ì•Šì€ ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }
            appState.switchScreen('dashboard');
        }

        function goHome() {
            if (appState.currentScreen === 'labeling' && appState.isLabelChanged()) {
                if (!confirm('ì €ì¥ë˜ì§€ ì•Šì€ ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤. í™ˆìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }
            appState.switchScreen('dashboard');
        }

        function logout() {
            let confirmMessage = 'ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            if (appState.currentScreen === 'labeling' && appState.isLabelChanged()) {
                confirmMessage = 'ì €ì¥ë˜ì§€ ì•Šì€ ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            }
            if (confirm(confirmMessage)) {
                appState.switchScreen('login');
                document.getElementById('userCodeInput').value = '';
                appState.user = null;
                appState.batches = [];
                appState.currentBatch = null;
                appState.labels = {};
                appState.lastSavedLabels = {};
            }
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì²˜ë¦¬
        document.addEventListener('keydown', (event) => {
            if (appState.currentScreen !== 'labeling') return;

            switch(event.key) {
                case '1':
                    selectLabel('positive');
                    break;
                case '2':
                    selectLabel('negative');
                    break;
                case '3':
                    selectLabel('neutral');
                    break;
                case ' ':
                    event.preventDefault();
                    skipImage();
                    break;
                case 'Enter':
                case 'ArrowRight':
                    event.preventDefault();
                    nextImage();
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    previousImage();
                    break;
                case 'Escape':
                    event.preventDefault();
                    if (confirm('ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        backToDashboard();
                    }
                    break;
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ì´ë¯¸ì§€ ë¼ë²¨ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
            // ë¡œê·¸ì¸ ì…ë ¥ì°½ì—ì„œ Enterë¡œ ë¡œê·¸ì¸
            const userInput = document.getElementById('userCodeInput');
            if (userInput) {
                userInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        startLogin();
                    }
                });
            }
            // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ì—ì„œ Enterë¡œ ë¡œê·¸ì¸
            const adminInput = document.getElementById('adminPasswordInput');
            if (adminInput) {
                adminInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        adminLogin();
                    }
                });
            }
        });

        // ì €ì¥í•˜ê¸° ë²„íŠ¼ í•¨ìˆ˜
        async function saveProgressAndNotify() {
            try {
                await appState.saveProgress();
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (e) {
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë“œ ì„ íƒ/ë¶„ê¸° í•¨ìˆ˜ë“¤
        function showUserLogin() {
            document.getElementById('userLoginSection').style.display = '';
        }
        function showAdminLogin() {
            appState.switchScreen('adminAuth');
            document.getElementById('adminPasswordInput').value = '';
        }
        function backToModeSelect() {
            appState.switchScreen('login');
            document.getElementById('userLoginSection').style.display = 'none';
        }
        function adminLogin() {
            const pw = document.getElementById('adminPasswordInput').value;
            if (pw === 'admin123') {
                appState.switchScreen('adminDashboard');
                renderAdminDashboard();
            } else {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë Œë”ë§ (ìƒ˜í”Œ ë°ì´í„° ê¸°ë°˜)
        function renderAdminDashboard() {
            // ìƒ˜í”Œ: appState.batches, appState.labels, appState.user ë“± í™œìš©
            // ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì„œë²„ì—ì„œ ëª¨ë“  ì‚¬ìš©ì/ë°°ì¹˜/ë¼ë²¨ ë°ì´í„° ë°›ì•„ì™€ì•¼ í•¨
            let html = '<table border="1" cellpadding="5" style="border-collapse:collapse; width:100%;">';
            html += '<tr><th>ë°°ì¹˜</th><th>ì´ë¯¸ì§€</th><th>ë¼ë²¨</th></tr>';
            // ìƒ˜í”Œ: í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ë°ì´í„°ë§Œ í‘œì‹œ
            (appState.batches || []).forEach(batch => {
                (batch.images || []).forEach(img => {
                    const labels = (appState.labels && appState.labels[img.id]) ? appState.labels[img.id].join(', ') : '-';
                    html += `<tr><td>${batch.id}</td><td>${img.name}</td><td>${labels}</td></tr>`;
                });
            });
            html += '</table>';
            document.getElementById('adminResultsTable').innerHTML = html;
        }
    </script>
</body>
</html>