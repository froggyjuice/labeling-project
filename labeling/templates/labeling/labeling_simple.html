{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="screen">
        <!-- 네비게이션 헤더 -->
        <div class="nav-header">
            <div class="nav-left">
                <div class="logo">📊 ImageLabel</div>
                <div class="breadcrumb">
                    <span class="breadcrumb-item" onclick="goToDashboard()">대시보드</span>
                    <span class="breadcrumb-separator">></span>
                    <span class="breadcrumb-item active">{{ batch.name|default:"배치" }}</span>
                </div>
            </div>
            <div class="nav-right">
                <div class="quick-stats">
                    <span>🏷️ {{ current_index|add:1 }} / {{ total_images }}</span>
                </div>
                <a href="#" onclick="goToDashboard(); return false;" class="home-btn">🏠 홈</a>
                <a href="#" onclick="goToDashboard(); return false;" class="btn btn-small">대시보드</a>
            </div>
        </div>

        <div class="labeling-screen">
            <div class="image-section">
                <div class="image-container">
                    {% if current_image %}
                        <img id="currentImage" class="current-image" src="{{ current_image.url }}" alt="Label this image">
                    {% else %}
                        <div style="text-align: center; color: #666; font-size: 1.2rem;">
                            <h3>이미지를 로딩 중...</h3>
                            <p>잠시만 기다려주세요.</p>
                        </div>
                    {% endif %}
                </div>
                <div class="image-info">
                    <p>{{ current_image.file_name|default:"이미지를 로딩 중..." }}</p>
                </div>
            </div>

            <div class="controls-section">
                <div class="progress-info">
                    <h3>{{ batch.name|default:"배치" }}</h3>
                    <p>이미지 {{ current_index|add:1 }} / {{ total_images }}</p>
                    <div class="progress-bar" style="height: 8px;">
                        <div class="progress-fill" style="width: {{ progress_percentage }}%"></div>
                    </div>
                </div>

                <div class="label-options">
                    <button class="label-btn" data-label="positive" onclick="selectLabel('positive')">
                        긍정적 <span class="hotkey">1</span>
                    </button>
                    <button class="label-btn" data-label="negative" onclick="selectLabel('negative')">
                        부정적 <span class="hotkey">2</span>
                    </button>
                    <button class="label-btn" data-label="neutral" onclick="selectLabel('neutral')">
                        중립적 <span class="hotkey">3</span>
                    </button>
                </div>

                <div class="action-buttons">
                    <button class="nav-btn prev" onclick="goToPrevious()">이전</button>
                    <button class="nav-btn skip" onclick="skipCurrent()">보류</button>
                    <button class="nav-btn next" onclick="goToNext()">다음</button>
                </div>

                <button class="btn" style="width:100%;margin-top:10px;" onclick="saveCurrentProgress()">저장하기</button>

                <div class="hotkey-guide">
                    <h4>키보드 단축키</h4>
                    <p>1, 2, 3: 라벨 선택</p>
                    <p>Space: 보류</p>
                    <p>Enter / →: 다음 이미지</p>
                    <p>←: 이전 이미지</p>
                    <p>Esc: 대시보드로 돌아가기</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 데이터 설정
const appData = {
    batchId: {{ batch.id|default:1 }},
    currentIndex: {{ current_index|default:0 }},
    totalImages: {{ total_images|default:0 }},
    currentImageId: {{ current_image.id|default:'null' }}
};

// 애플리케이션 상태
let selectedLabels = [];
let hasChanges = false;

console.log('App Data:', appData);

// 라벨 선택 함수
function selectLabel(label) {
    console.log('Label selected:', label);
    const btn = document.querySelector(`[data-label="${label}"]`);
    
    if (btn.classList.contains('selected')) {
        btn.classList.remove('selected');
        selectedLabels = selectedLabels.filter(l => l !== label);
    } else {
        btn.classList.add('selected');
        selectedLabels.push(label);
    }
    
    hasChanges = true;
    console.log('Selected labels:', selectedLabels);
}

// 저장 확인 모달 HTML 생성
function createSaveConfirmModal() {
    const modal = document.createElement('div');
    modal.id = 'saveConfirmModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: modalSlideIn 0.3s ease-out;
        ">
            <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
            <h3 style="margin: 0 0 15px 0; color: #333; font-size: 20px;">
                현재까지의 진행상황을 저장하고 나가시겠습니까?
            </h3>
            <p style="margin: 0 0 25px 0; color: #666; font-size: 14px;">
                저장하지 않으면 현재 이미지의 라벨링 작업이 손실됩니다.
            </p>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button id="saveAndLeave" style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 12px 18px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 13px;
                    font-weight: 500;
                    margin: 5px;
                ">저장하고 나가기</button>
                <button id="stayOnPage" style="
                    background: #6c757d;
                    color: white;
                    border: none;
                    padding: 12px 18px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 13px;
                    font-weight: 500;
                    margin: 5px;
                ">페이지에 머무르기</button>
                <button id="leaveWithoutSave" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 12px 18px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 13px;
                    font-weight: 500;
                    margin: 5px;
                ">저장없이 나가기</button>
            </div>
        </div>
    `;
    
    // 애니메이션 CSS 추가
    if (!document.getElementById('modalAnimationCSS')) {
        const style = document.createElement('style');
        style.id = 'modalAnimationCSS';
        style.textContent = `
            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: scale(0.9) translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(modal);
    return modal;
}

// 저장 확인 함수
function showSaveConfirmation(callback) {
    if (!hasChanges) {
        callback(true);
        return;
    }
    
    const modal = createSaveConfirmModal();
    
    // 버튼 이벤트 리스너
    document.getElementById('saveAndLeave').onclick = function() {
        // 현재 라벨 저장 후 나가기
        if (selectedLabels.length > 0) {
            saveLabelToDatabase(() => {
                hasChanges = false;
                document.body.removeChild(modal);
                callback(true);
            });
        } else {
            // 선택된 라벨이 없으면 그냥 나가기
            hasChanges = false;
            document.body.removeChild(modal);
            callback(true);
        }
    };
    
    document.getElementById('stayOnPage').onclick = function() {
        document.body.removeChild(modal);
        callback(false);
    };
    
    document.getElementById('leaveWithoutSave').onclick = function() {
        hasChanges = false;
        document.body.removeChild(modal);
        callback(true);
    };
    
    // 모달 배경 클릭 시 머무르기
    modal.onclick = function(e) {
        if (e.target === modal) {
            document.body.removeChild(modal);
            callback(false);
        }
    };
}

// 네비게이션 함수들
function goToNext() {
    console.log('Going to next image');
    if (selectedLabels.length === 0) {
        alert('라벨을 하나 이상 선택해주세요!');
        return;
    }
    
    // 라벨 저장 후 다음 이미지로 이동
    saveLabelToDatabase(() => {
        hasChanges = false;
        const nextIndex = appData.currentIndex + 1;
        if (nextIndex < appData.totalImages) {
            window.location.href = `/labeling/${appData.batchId}/?index=${nextIndex}`;
        } else {
            alert('배치가 완료되었습니다!');
            window.location.href = '/dashboard/';
        }
    });
}

function goToPrevious() {
    console.log('Going to previous image');
    if (appData.currentIndex > 0) {
        showSaveConfirmation((shouldLeave) => {
            if (shouldLeave) {
                const prevIndex = appData.currentIndex - 1;
                window.location.href = `/labeling/${appData.batchId}/?index=${prevIndex}`;
            }
        });
    }
}

function skipCurrent() {
    console.log('Skipping current image');
    selectedLabels = [];
    document.querySelectorAll('.label-btn').forEach(btn => btn.classList.remove('selected'));
    
    hasChanges = false;
    
    const nextIndex = appData.currentIndex + 1;
    if (nextIndex < appData.totalImages) {
        window.location.href = `/labeling/${appData.batchId}/?index=${nextIndex}`;
    } else {
        alert('배치가 완료되었습니다!');
        window.location.href = '/dashboard/';
    }
}

function goToDashboard() {
    showSaveConfirmation((shouldLeave) => {
        if (shouldLeave) {
            window.location.href = '/dashboard/';
        }
    });
}

function saveCurrentProgress() {
    console.log('Saving progress');
    fetch('/api/labeling/save-progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            batchId: appData.batchId,
            currentIndex: appData.currentIndex,
            labels: {[`batch_${appData.batchId}_image_${appData.currentIndex}`]: selectedLabels},
            timestamp: new Date().toISOString()
        })
    })
    .then(response => response.json())
    .then(data => {
        hasChanges = false;
        alert('저장되었습니다!');
    })
    .catch(error => {
        console.error('Save error:', error);
        alert('저장되었습니다! (로컬 저장)');
    });
}

// 데이터베이스에 라벨 저장
function saveLabelToDatabase(callback) {
    console.log('Saving label to database');
    const currentImageId = getCurrentImageId();
    
    fetch('/api/labeling/save-label', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            imageId: currentImageId,
            labels: selectedLabels
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Label saved successfully');
        if (callback) callback();
    })
    .catch(error => {
        console.error('Save label error:', error);
        if (callback) callback(); // 에러가 발생해도 다음으로 진행
    });
}

// 현재 이미지 ID 가져오기
function getCurrentImageId() {
    return appData.currentImageId;
}

// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 키보드 단축키
document.addEventListener('keydown', function(event) {
    // 모달이 열려있으면 키보드 단축키 비활성화
    if (document.getElementById('saveConfirmModal')) {
        return;
    }
    
    switch(event.key) {
        case '1':
            event.preventDefault();
            selectLabel('positive');
            break;
        case '2':
            event.preventDefault();
            selectLabel('negative');
            break;
        case '3':
            event.preventDefault();
            selectLabel('neutral');
            break;
        case ' ':
            event.preventDefault();
            skipCurrent();
            break;
        case 'Enter':
        case 'ArrowRight':
            event.preventDefault();
            goToNext();
            break;
        case 'ArrowLeft':
            event.preventDefault();
            goToPrevious();
            break;
        case 'Escape':
            event.preventDefault();
            goToDashboard();
            break;
    }
});

// beforeunload 이벤트 (브라우저 새로고침, 닫기 등)
window.addEventListener('beforeunload', function(e) {
    if (hasChanges) {
        e.preventDefault();
        e.returnValue = '저장되지 않은 변경사항이 있습니다.';
        return e.returnValue;
    }
});

console.log('Labeling page initialized');
</script>
{% endblock %} 