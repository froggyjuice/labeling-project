{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="screen">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ í—¤ë” -->
        <div class="nav-header">
            <div class="nav-left">
                <div class="logo">ğŸ“Š ImageLabel</div>
                <div class="breadcrumb">
                    <span class="breadcrumb-item" onclick="location.href='/dashboard/'">ëŒ€ì‹œë³´ë“œ</span>
                    <span class="breadcrumb-separator">></span>
                    <span class="breadcrumb-item active">{{ batch.name|default:"ë°°ì¹˜" }}</span>
                </div>
            </div>
            <div class="nav-right">
                <div class="quick-stats">
                    <span>ğŸ·ï¸ {{ current_index|add:1 }} / {{ total_images }}</span>
                </div>
                <a href="/dashboard/" class="home-btn">ğŸ  í™ˆ</a>
                <a href="/dashboard/" class="btn btn-small">ëŒ€ì‹œë³´ë“œ</a>
            </div>
        </div>

        <div class="labeling-screen">
            <div class="image-section">
                <div class="image-container">
                    {% if current_image %}
                        <img id="currentImage" class="current-image" src="{{ current_image.url }}" alt="Label this image">
                    {% else %}
                        <div style="text-align: center; color: #666; font-size: 1.2rem;">
                            <h3>ì´ë¯¸ì§€ë¥¼ ë¡œë”© ì¤‘...</h3>
                            <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                        </div>
                    {% endif %}
                </div>
                <div class="image-info">
                    <p>{{ current_image.file_name|default:"ì´ë¯¸ì§€ë¥¼ ë¡œë”© ì¤‘..." }}</p>
                </div>
            </div>

            <div class="controls-section">
                <div class="progress-info">
                    <h3>{{ batch.name|default:"ë°°ì¹˜" }}</h3>
                    <p>ì´ë¯¸ì§€ {{ current_index|add:1 }} / {{ total_images }}</p>
                    <div class="progress-bar" style="height: 8px;">
                        <div class="progress-fill" style="width: {{ progress_percentage }}%"></div>
                    </div>
                </div>

                <div class="label-options">
                    <button class="label-btn" data-label="positive" onclick="selectLabel('positive')">
                        ê¸ì •ì  <span class="hotkey">1</span>
                    </button>
                    <button class="label-btn" data-label="negative" onclick="selectLabel('negative')">
                        ë¶€ì •ì  <span class="hotkey">2</span>
                    </button>
                    <button class="label-btn" data-label="neutral" onclick="selectLabel('neutral')">
                        ì¤‘ë¦½ì  <span class="hotkey">3</span>
                    </button>
                </div>

                <div class="action-buttons">
                    <button class="nav-btn prev" onclick="goToPrevious()">ì´ì „</button>
                    <button class="nav-btn skip" onclick="skipCurrent()">ë³´ë¥˜</button>
                    <button class="nav-btn next" onclick="goToNext()">ë‹¤ìŒ</button>
                </div>

                <button class="btn" style="width:100%;margin-top:10px;" onclick="saveCurrentProgress()">ì €ì¥í•˜ê¸°</button>

                <div class="hotkey-guide">
                    <h4>í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</h4>
                    <p>1, 2, 3: ë¼ë²¨ ì„ íƒ</p>
                    <p>Space: ë³´ë¥˜</p>
                    <p>Enter / â†’: ë‹¤ìŒ ì´ë¯¸ì§€</p>
                    <p>â†: ì´ì „ ì´ë¯¸ì§€</p>
                    <p>Esc: ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ë°ì´í„° ì„¤ì •
const appData = {
    batchId: {{ batch.id|default:1 }},
    currentIndex: {{ current_index|default:0 }},
    totalImages: {{ total_images|default:0 }},
    currentImageId: {{ current_image.id|default:'null' }}
};

// ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ
let selectedLabels = [];
let hasChanges = false;

console.log('App Data:', appData);

// ë¼ë²¨ ì„ íƒ í•¨ìˆ˜
function selectLabel(label) {
    console.log('Label selected:', label);
    const btn = document.querySelector(`[data-label="${label}"]`);
    
    if (btn.classList.contains('selected')) {
        btn.classList.remove('selected');
        selectedLabels = selectedLabels.filter(l => l !== label);
    } else {
        btn.classList.add('selected');
        selectedLabels.push(label);
    }
    
    hasChanges = true;
    console.log('Selected labels:', selectedLabels);
}

// ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
function goToNext() {
    console.log('Going to next image');
    if (selectedLabels.length === 0) {
        alert('ë¼ë²¨ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”!');
        return;
    }
    
    // ë¼ë²¨ ì €ì¥ í›„ ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ì´ë™
    saveLabelToDatabase(() => {
    hasChanges = false;
    const nextIndex = appData.currentIndex + 1;
    if (nextIndex < appData.totalImages) {
        window.location.href = `/labeling/${appData.batchId}/?index=${nextIndex}`;
    } else {
        alert('ë°°ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        window.location.href = '/dashboard/';
    }
    });
}

function goToPrevious() {
    console.log('Going to previous image');
    if (appData.currentIndex > 0) {
        // ì´ì „ ì´ë¯¸ì§€ë¡œ ì´ë™í•  ë•Œë„ ë³€ê²½ì‚¬í•­ ê²½ê³  ì œê±°
        hasChanges = false;
        const prevIndex = appData.currentIndex - 1;
        window.location.href = `/labeling/${appData.batchId}/?index=${prevIndex}`;
    }
}

function skipCurrent() {
    console.log('Skipping current image');
    selectedLabels = [];
    document.querySelectorAll('.label-btn').forEach(btn => btn.classList.remove('selected'));
    
    // ë³´ë¥˜í•  ë•Œë„ ë³€ê²½ì‚¬í•­ ê²½ê³  ì œê±°
    hasChanges = false;
    
    const nextIndex = appData.currentIndex + 1;
    if (nextIndex < appData.totalImages) {
        window.location.href = `/labeling/${appData.batchId}/?index=${nextIndex}`;
    } else {
        alert('ë°°ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        window.location.href = '/dashboard/';
    }
}

function saveCurrentProgress() {
    console.log('Saving progress');
    fetch('/api/labeling/save-progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            batchId: appData.batchId,
            currentIndex: appData.currentIndex,
            labels: {[`batch_${appData.batchId}_image_${appData.currentIndex}`]: selectedLabels},
            timestamp: new Date().toISOString()
        })
    })
    .then(response => response.json())
    .then(data => {
        hasChanges = false;
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    })
    .catch(error => {
        console.error('Save error:', error);
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¡œì»¬ ì €ì¥)');
    });
}

// ë°ì´í„°ë² ì´ìŠ¤ì— ë¼ë²¨ ì €ì¥
function saveLabelToDatabase(callback) {
    console.log('Saving label to database');
    const currentImageId = getCurrentImageId();
    
    fetch('/api/labeling/save-label', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            imageId: currentImageId,
            labels: selectedLabels
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Label saved successfully');
        if (callback) callback();
    })
    .catch(error => {
        console.error('Save label error:', error);
        if (callback) callback(); // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë‹¤ìŒìœ¼ë¡œ ì§„í–‰
    });
}

// í˜„ì¬ ì´ë¯¸ì§€ ID ê°€ì ¸ì˜¤ê¸°
function getCurrentImageId() {
    return appData.currentImageId;
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', function(event) {
    switch(event.key) {
        case '1':
            event.preventDefault();
            selectLabel('positive');
            break;
        case '2':
            event.preventDefault();
            selectLabel('negative');
            break;
        case '3':
            event.preventDefault();
            selectLabel('neutral');
            break;
        case ' ':
            event.preventDefault();
            skipCurrent();
            break;
        case 'Enter':
        case 'ArrowRight':
            event.preventDefault();
            goToNext();
            break;
        case 'ArrowLeft':
            event.preventDefault();
            goToPrevious();
            break;
        case 'Escape':
            event.preventDefault();
            if (confirm('ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.href = '/dashboard/';
            }
            break;
    }
});

// í˜ì´ì§€ ë²—ì–´ë‚˜ê¸° ì „ ê²½ê³  (ì •ìƒì ì¸ ë„¤ë¹„ê²Œì´ì…˜ì€ ì œì™¸)
let isNavigating = false;

window.addEventListener('beforeunload', function(e) {
    if (hasChanges && !isNavigating) {
        e.preventDefault();
        e.returnValue = 'ì €ì¥ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.';
        return e.returnValue;
    }
});

console.log('Labeling page initialized');
</script>
{% endblock %} 