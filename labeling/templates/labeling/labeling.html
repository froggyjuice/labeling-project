{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="screen">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ í—¤ë” -->
        <div class="nav-header">
            <div class="nav-left">
                <div class="logo" onclick="goHome()">ğŸ“Š ImageLabel</div>
                <div class="breadcrumb">
                    <span class="breadcrumb-item" onclick="goHome()">ëŒ€ì‹œë³´ë“œ</span>
                    <span class="breadcrumb-separator">></span>
                    <span class="breadcrumb-item active">{{ batch.name|default:"ë°°ì¹˜" }}</span>
                </div>
            </div>
            <div class="nav-right">
                <div class="quick-stats">
                    <div class="stat-item">
                        <span>ğŸ·ï¸</span>
                        <span id="quickImageProgress">{{ current_index|add:1 }} / {{ total_images }}</span>
                    </div>
                </div>
                <a href="#" onclick="goHome(); return false;" class="home-btn">ğŸ  í™ˆ</a>
                <a href="#" onclick="goHome(); return false;" class="btn btn-small">ëŒ€ì‹œë³´ë“œ</a>
            </div>
        </div>

        <div class="labeling-screen">
            <div class="image-section">
                <div class="image-container">
                    {% if current_image %}
                        <img id="currentImage" class="current-image" src="{{ current_image.url }}" alt="Label this image">
                    {% else %}
                        <div style="text-align: center; color: #666; font-size: 1.2rem;">
                            <h3>ì´ë¯¸ì§€ë¥¼ ë¡œë”© ì¤‘...</h3>
                            <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                        </div>
                    {% endif %}
                </div>
                <div class="image-info">
                    <p id="imageFileName">{{ current_image.file_name|default:"ì´ë¯¸ì§€ë¥¼ ë¡œë”© ì¤‘..." }}</p>
                </div>
            </div>

            <div class="controls-section">
                <div class="progress-info">
                    <h3>{{ batch.name|default:"ë°°ì¹˜" }}</h3>
                    <p id="imageProgress">ì´ë¯¸ì§€ {{ current_index|add:1 }} / {{ total_images }}</p>
                    <div class="progress-bar" style="height: 8px;">
                        <div class="progress-fill" style="width: {{ progress_percentage }}%"></div>
                    </div>
                    <!-- í˜„ì¬ ì´ë¯¸ì§€ IDë¥¼ hidden inputìœ¼ë¡œ ì „ë‹¬ -->
                    <input type="hidden" id="currentImageId" value="{% if current_image %}{{ current_image.id }}{% else %}0{% endif %}">
                </div>

                <div class="label-options">
                    <button class="label-btn" data-label="positive" onclick="selectLabel('positive')">
                        ê¸ì •ì  <span class="hotkey">1</span>
                    </button>
                    <button class="label-btn" data-label="negative" onclick="selectLabel('negative')">
                        ë¶€ì •ì  <span class="hotkey">2</span>
                    </button>
                    <button class="label-btn" data-label="neutral" onclick="selectLabel('neutral')">
                        ì¤‘ë¦½ì  <span class="hotkey">3</span>
                    </button>
                </div>

                <div class="action-buttons">
                    <button class="nav-btn prev" onclick="previousImage()">ì´ì „</button>
                    <button class="nav-btn skip" onclick="skipImage()">ë³´ë¥˜</button>
                    <button class="nav-btn next" onclick="nextImage()">ë‹¤ìŒ</button>
                </div>

                <button class="btn" style="width:100%;margin-top:10px;" onclick="saveProgress()">ì €ì¥í•˜ê¸°</button>

                <div class="hotkey-guide">
                    <h4>í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</h4>
                    <p>1, 2, 3: ë¼ë²¨ ì„ íƒ</p>
                    <p>Space: ë³´ë¥˜</p>
                    <p>Enter / â†’: ë‹¤ìŒ ì´ë¯¸ì§€</p>
                    <p>â†: ì´ì „ ì´ë¯¸ì§€</p>
                    <p>Esc: ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Django í…œí”Œë¦¿ì—ì„œ JavaScriptë¡œ ë°ì´í„° ì „ë‹¬
const DJANGO_DATA = {
    batchId: {{ batch.id|default:0 }},
    currentIndex: {{ current_index|default:0 }},
    totalImages: {{ total_images|default:0 }},
    currentImageId: {{ current_image.id|default:0 }},
    dashboardUrl: "{% url 'dashboard' %}",
    currentBatchUrl: "{% url 'labeling' batch.id|default:1 %}"
};

// ê°•í™”ëœ ì €ì¥ ìƒíƒœ ìºì‹± ì‹œìŠ¤í…œ
const CacheManager = {
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
    LOCAL_STORAGE_KEY: 'labeling_cache_',
    SESSION_STORAGE_KEY: 'labeling_session_',
    
    // í˜„ì¬ ì´ë¯¸ì§€ì˜ ìºì‹œ í‚¤ ìƒì„±
    getCacheKey: function(batchId, imageId) {
        return `${this.LOCAL_STORAGE_KEY}${batchId}_${imageId}`;
    },
    
    // ì„¸ì…˜ ìºì‹œ í‚¤ ìƒì„±
    getSessionKey: function(batchId) {
        return `${this.SESSION_STORAGE_KEY}${batchId}`;
    },
    
    // ë¼ë²¨ ì €ì¥ (ë¡œì»¬ + ì„¸ì…˜ + ì„œë²„)
    saveLabels: function(batchId, imageId, labels) {
        const timestamp = new Date().toISOString();
        const cacheData = {
            batchId: batchId,
            imageId: imageId,
            labels: labels,
            timestamp: timestamp,
            saved: false
        };
        
        // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ì„¸ì…˜ ì¢…ë£Œ ë³´í˜¸)
        try {
            localStorage.setItem(this.getCacheKey(batchId, imageId), JSON.stringify(cacheData));
        } catch (e) {
            console.warn('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨:', e);
        }
        
        // 2. ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ì„ì‹œ ì €ì¥)
        try {
            sessionStorage.setItem(this.getCacheKey(batchId, imageId), JSON.stringify(cacheData));
        } catch (e) {
            console.warn('ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨:', e);
        }
        
        // 3. ì„¸ì…˜ ì „ì²´ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
        this.updateSessionProgress(batchId, imageId, labels);
        
        return cacheData;
    },
    
    // ë¼ë²¨ ë¡œë“œ
    loadLabels: function(batchId, imageId) {
        // 1ì°¨: ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œ (ë¹ ë¦„)
        try {
            const sessionData = sessionStorage.getItem(this.getCacheKey(batchId, imageId));
            if (sessionData) {
                return JSON.parse(sessionData);
            }
        } catch (e) {
            console.warn('ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
        
        // 2ì°¨: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œ (ë³µêµ¬)
        try {
            const localData = localStorage.getItem(this.getCacheKey(batchId, imageId));
            if (localData) {
                const data = JSON.parse(localData);
                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ë„ ë³µì‚¬
                sessionStorage.setItem(this.getCacheKey(batchId, imageId), localData);
                return data;
            }
        } catch (e) {
            console.warn('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
        
        return null;
    },
    
    // ì„¸ì…˜ ì „ì²´ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
    updateSessionProgress: function(batchId, imageId, labels) {
        try {
            const sessionKey = this.getSessionKey(batchId);
            let sessionProgress = {};
            
            const existingData = sessionStorage.getItem(sessionKey);
            if (existingData) {
                sessionProgress = JSON.parse(existingData);
            }
            
            sessionProgress[imageId] = {
                labels: labels,
                timestamp: new Date().toISOString()
            };
            
            sessionStorage.setItem(sessionKey, JSON.stringify(sessionProgress));
        } catch (e) {
            console.warn('ì„¸ì…˜ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
        }
    },
    
    // ì„œë²„ ì €ì¥ ì™„ë£Œ í‘œì‹œ
    markAsSaved: function(batchId, imageId) {
        const cacheKey = this.getCacheKey(batchId, imageId);
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
        try {
            const localData = localStorage.getItem(cacheKey);
            if (localData) {
                const data = JSON.parse(localData);
                data.saved = true;
                data.serverSavedAt = new Date().toISOString();
                localStorage.setItem(cacheKey, JSON.stringify(data));
            }
        } catch (e) {
            console.warn('ë¡œì»¬ ì €ì¥ ì™„ë£Œ í‘œì‹œ ì‹¤íŒ¨:', e);
        }
    },
    
    // ë¯¸ì €ì¥ ë°ì´í„° ê²€ìƒ‰
    getUnsavedData: function(batchId) {
        const unsaved = [];
        try {
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(`${this.LOCAL_STORAGE_KEY}${batchId}_`)) {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (!data.saved) {
                        unsaved.push(data);
                    }
                }
            }
        } catch (e) {
            console.warn('ë¯¸ì €ì¥ ë°ì´í„° ê²€ìƒ‰ ì‹¤íŒ¨:', e);
        }
        return unsaved;
    },
    
    // ìºì‹œ ì •ë¦¬ (ì„ íƒì )
    cleanup: function(batchId, olderThanDays = 7) {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - olderThanDays);
        
        try {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(`${this.LOCAL_STORAGE_KEY}${batchId}_`)) {
                    const data = JSON.parse(localStorage.getItem(key));
                    const dataDate = new Date(data.timestamp);
                    if (data.saved && dataDate < cutoffDate) {
                        keysToRemove.push(key);
                    }
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            console.log(`${keysToRemove.length}ê°œì˜ ì˜¤ë˜ëœ ìºì‹œ í•­ëª©ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.`);
        } catch (e) {
            console.warn('ìºì‹œ ì •ë¦¬ ì‹¤íŒ¨:', e);
        }
    }
};

// ë¼ë²¨ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ (ì™„ì „ ì¬êµ¬ì„±)
const labelingState = {
    batchId: DJANGO_DATA.batchId,
    currentIndex: DJANGO_DATA.currentIndex,
    totalImages: DJANGO_DATA.totalImages,
    currentImageId: DJANGO_DATA.currentImageId,
    selectedLabels: [],
    isAutoSaving: false,
    lastServerSyncTime: null,
    
    // ì´ˆê¸°í™”
    initialize: function() {
        // í˜„ì¬ ì´ë¯¸ì§€ì˜ ì €ì¥ëœ ë¼ë²¨ ë³µì›
        this.restoreCurrentImageLabels();
        
        // ë¯¸ì €ì¥ ë°ì´í„° ì„œë²„ ë™ê¸°í™” ì‹œë„
        this.syncUnsavedData();
        
        // ì£¼ê¸°ì  ë°±ì—… ì‹œì‘ (30ì´ˆë§ˆë‹¤)
        setInterval(() => {
            this.periodicBackup();
        }, 30000);
    },
    
    // í˜„ì¬ ì´ë¯¸ì§€ ë¼ë²¨ ë³µì›
    restoreCurrentImageLabels: function() {
        const cachedData = CacheManager.loadLabels(this.batchId, this.currentImageId);
        if (cachedData && cachedData.labels && cachedData.labels.length > 0) {
            this.selectedLabels = [...cachedData.labels];
            
            // UIì— ë³µì›
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            this.selectedLabels.forEach(label => {
                const btn = document.querySelector(`[data-label="${label}"]`);
                if (btn) {
                    btn.classList.add('selected');
                }
            });
            
            console.log('ë¼ë²¨ ë³µì›ë¨:', this.selectedLabels);
        }
    },     
    
    // ë¼ë²¨ ì„ íƒ/í•´ì œ (ê°•í™”ëœ ìë™ ì €ì¥)
    selectLabel: function(label) {
        const btn = document.querySelector(`[data-label="${label}"]`);
        if (btn.classList.contains('selected')) {
            btn.classList.remove('selected');
            this.selectedLabels = this.selectedLabels.filter(l => l !== label);
        } else {
            btn.classList.add('selected');
            this.selectedLabels.push(label);
        }
        
        // ì¦‰ì‹œ ìºì‹œì— ì €ì¥
        CacheManager.saveLabels(this.batchId, this.currentImageId, this.selectedLabels);
        
        // ì„œë²„ì— ìë™ ì €ì¥ (ë¹„ë™ê¸°, ì•Œë¦¼ ì—†ìŒ)
        this.autoSaveToServer();
    },
    
    // ê°•í™”ëœ ìë™ ì €ì¥
    autoSaveToServer: async function() {
        if (this.isAutoSaving) return; // ì¤‘ë³µ ì €ì¥ ë°©ì§€
        
        this.isAutoSaving = true;
        
        try {
            if (this.selectedLabels.length > 0) {
                const success = await this.saveLabelToServer(this.currentImageId, this.selectedLabels, false);
                if (success) {
                    // ì„œë²„ ì €ì¥ ì„±ê³µ í‘œì‹œ
                    CacheManager.markAsSaved(this.batchId, this.currentImageId);
                    this.lastServerSyncTime = new Date();
                }
            }
        } catch (error) {
            console.log('ìë™ ì €ì¥ ì‹¤íŒ¨, ë¡œì»¬ ìºì‹œì— ë³´ê´€ë¨:', error);
        } finally {
            this.isAutoSaving = false;
        }
    },
    
    // ë¯¸ì €ì¥ ë°ì´í„° ì„œë²„ ë™ê¸°í™”
    syncUnsavedData: async function() {
        const unsavedData = CacheManager.getUnsavedData(this.batchId);
        if (unsavedData.length > 0) {
            console.log(`${unsavedData.length}ê°œì˜ ë¯¸ì €ì¥ ë°ì´í„°ë¥¼ ì„œë²„ì™€ ë™ê¸°í™” ì¤‘...`);
            
            for (const data of unsavedData) {
                try {
                    const success = await this.saveLabelToServer(data.imageId, data.labels, false);
                    if (success) {
                        CacheManager.markAsSaved(data.batchId, data.imageId);
                    }
                } catch (error) {
                    console.warn('ë™ê¸°í™” ì‹¤íŒ¨:', data, error);
                }
            }
        }
    },
    
    // ì£¼ê¸°ì  ë°±ì—…
    periodicBackup: function() {
        if (this.selectedLabels.length > 0) {
            CacheManager.saveLabels(this.batchId, this.currentImageId, this.selectedLabels);
        }
    },
    
    // ì„œë²„ì— ë¼ë²¨ ì €ì¥
    saveLabelToServer: async function(imageId, labels, showAlert = true) {
        try {
            const response = await fetch('/api/labeling/save-label', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: JSON.stringify({
                    imageId: imageId,
                    labels: labels
                })
            });
            
            if (response.ok) {
                if (showAlert) console.log('ë¼ë²¨ ì €ì¥ ì„±ê³µ:', imageId, labels);
                return true;
            } else {
                if (showAlert) console.error('ë¼ë²¨ ì €ì¥ ì‹¤íŒ¨:', response.status);
                return false;
            }
        } catch (error) {
            if (showAlert) console.error('ë¼ë²¨ ì €ì¥ ì˜¤ë¥˜:', error);
            return false;
        }
    }
};

// ë¼ë²¨ ì„ íƒ í•¨ìˆ˜
function selectLabel(label) {
    labelingState.selectLabel(label);
}

// ë¼ë²¨ ì„ íƒ í•¨ìˆ˜
function selectLabel(label) {
    labelingState.selectLabel(label);
}

// ê°•í™”ëœ ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
async function nextImage() {
    console.log('nextImage í˜¸ì¶œë¨');
    if (labelingState.selectedLabels.length === 0) {
        alert('ë¼ë²¨ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”!');
        return;
    }
    
    // 1. í˜„ì¬ ì´ë¯¸ì§€ ë¼ë²¨ ìë™ ì €ì¥ (ì´ë¯¸ ìºì‹œì™€ ì„œë²„ì— ì €ì¥ë¨)
    if (labelingState.selectedLabels.length > 0) {
        await labelingState.autoSaveToServer();
    }
    
    // 2. ì§„í–‰ë¥  UI ì—…ë°ì´íŠ¸
    const nextIndex = labelingState.currentIndex + 1;
    const newProgress = Math.round((nextIndex / labelingState.totalImages) * 100);
    
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill) {
        progressFill.style.width = newProgress + '%';
    }
    
    const progressTexts = document.querySelectorAll('#imageProgress, #quickImageProgress');
    progressTexts.forEach(element => {
        if (element) {
            element.textContent = `ì´ë¯¸ì§€ ${nextIndex + 1} / ${labelingState.totalImages}`;
        }
    });
    
    // 3. ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ì´ë™
    if (nextIndex < labelingState.totalImages) {
        setTimeout(() => {
            window.location.href = `/labeling/${labelingState.batchId}/?index=${nextIndex}`;
        }, 200);
    } else {
        // ë°°ì¹˜ ì™„ë£Œ ì‹œ ìºì‹œ ì •ë¦¬
        CacheManager.cleanup(labelingState.batchId);
        alert('ë°°ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        window.location.href = '/dashboard/';
    }
}

async function previousImage() {
    console.log('previousImage í˜¸ì¶œë¨');
    if (labelingState.currentIndex > 0) {
        // 1. í˜„ì¬ ì‘ì—… ìë™ ì €ì¥
        if (labelingState.selectedLabels.length > 0) {
            await labelingState.autoSaveToServer();
        }
        
        // 2. ì´ì „ ì´ë¯¸ì§€ë¡œ ì´ë™ (ì €ì¥ëœ ë¼ë²¨ì´ ìë™ ë³µì›ë¨)
        const prevIndex = labelingState.currentIndex - 1;
        window.location.href = `/labeling/${labelingState.batchId}/?index=${prevIndex}`;
    }
}

async function skipImage() {
    console.log('skipImage í˜¸ì¶œë¨');
    
    // 1. ë³´ë¥˜ ìƒíƒœë¡œ ì €ì¥
    labelingState.selectedLabels = ['skipped'];
    CacheManager.saveLabels(labelingState.batchId, labelingState.currentImageId, ['skipped']);
    await labelingState.saveLabelToServer(labelingState.currentImageId, ['skipped'], false);
    
    // 2. UI ì´ˆê¸°í™”
    document.querySelectorAll('.label-btn').forEach(btn => btn.classList.remove('selected'));
    
    // 3. ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ì´ë™
    const nextIndex = labelingState.currentIndex + 1;
    if (nextIndex < labelingState.totalImages) {
        const newProgress = Math.round((nextIndex / labelingState.totalImages) * 100);
        const progressFill = document.querySelector('.progress-fill');
        if (progressFill) {
            progressFill.style.width = newProgress + '%';
        }
        
        setTimeout(() => {
            window.location.href = `/labeling/${labelingState.batchId}/?index=${nextIndex}`;
        }, 200);
    } else {
        CacheManager.cleanup(labelingState.batchId);
        alert('ë°°ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        window.location.href = '/dashboard/';
    }
}

// ìë™ì €ì¥ ì§„í–‰ìƒí™© ëª¨ë‹¬ ìƒì„±
function createAutoSaveModal() {
    const modal = document.createElement('div');
    modal.id = 'autoSaveModal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5); display: flex; align-items: center;
        justify-content: center; z-index: 10000;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 30px;
                    max-width: 400px; width: 90%; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    text-align: center; animation: modalSlideIn 0.3s ease-out;">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ’¾</div>
            <h3 style="margin: 0 0 15px 0; color: #333; font-size: 20px;">
                ìë™ì €ì¥ ë‚´ì—­ ì—…ë°ì´íŠ¸ ì¤‘...
            </h3>
            <p style="margin: 0 0 25px 0; color: #666; font-size: 14px;">
                í˜„ì¬ê¹Œì§€ì˜ ì‘ì—… ë‚´ìš©ì„ ì„œë²„ì— ë™ê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤.
            </p>
            <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; 
                           border-top: 4px solid #007bff; border-radius: 50%; 
                           animation: spin 1s linear infinite;"></div>
            </div>
            <div style="display: flex; gap: 8px; justify-content: center;">
                <button id="waitForSave" style="background: #007bff; color: white; border: none;
                        padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;
                        font-weight: 500;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</button>
            </div>
        </div>
    `;
    
    // íšŒì „ ì• ë‹ˆë©”ì´ì…˜ CSS ì¶”ê°€
    if (!document.getElementById('spinAnimationCSS')) {
        const style = document.createElement('style');
        style.id = 'spinAnimationCSS';
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            @keyframes modalSlideIn {
                from { opacity: 0; transform: scale(0.9) translateY(-10px); }
                to { opacity: 1; transform: scale(1) translateY(0); }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(modal);
    return modal;
}

// í™ˆìœ¼ë¡œ ê°€ê¸° (ìë™ì €ì¥ í›„ ì´ë™)
async function goHome() {
    console.log('goHome í˜¸ì¶œë¨ - ìë™ì €ì¥ í›„ ì´ë™');
    
    // 1. ìë™ì €ì¥ ëª¨ë‹¬ í‘œì‹œ
    const modal = createAutoSaveModal();
    
    try {
        // 2. í˜„ì¬ ì‘ì—… ìë™ ì €ì¥
        if (labelingState.selectedLabels.length > 0) {
            await labelingState.autoSaveToServer();
        }
        
        // 3. ë¯¸ì €ì¥ ë°ì´í„° ë™ê¸°í™”
        await labelingState.syncUnsavedData();
        
        // 4. ì ì‹œ ëŒ€ê¸° í›„ ì´ë™ (ì‚¬ìš©ìê°€ ì €ì¥ ê³¼ì •ì„ ì¸ì§€í•  ìˆ˜ ìˆë„ë¡)
        setTimeout(() => {
            modal.remove();
            window.location.href = '/dashboard/';
        }, 1500);
        
    } catch (error) {
        console.error('ìë™ì €ì¥ ì‹¤íŒ¨:', error);
        modal.remove();
        
        // ì €ì¥ ì‹¤íŒ¨ ì‹œì—ë„ ì´ë™ (ë¡œì»¬ ìºì‹œì— ë³´ê´€ë¨)
        const confirmLeave = confirm('ìë™ì €ì¥ì— ì‹¤íŒ¨í–ˆì§€ë§Œ ë¡œì»¬ì— ë³´ê´€ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (confirmLeave) {
            window.location.href = '/dashboard/';
        }
    }
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', function(event) {
    switch(event.key) {
        case '1':
            event.preventDefault();
            selectLabel('positive');
            break;
        case '2':
            event.preventDefault();
            selectLabel('negative');
            break;
        case '3':
            event.preventDefault();
            selectLabel('neutral');
            break;
        case ' ':
            event.preventDefault();
            skipImage();
            break;
        case 'Enter':
        case 'ArrowRight':
            event.preventDefault();
            nextImage();
            break;
        case 'ArrowLeft':
            event.preventDefault();
            previousImage();
            break;
        case 'Escape':
            event.preventDefault();
            goHome();
            break;
    }
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // ê°•í™”ëœ ìºì‹± ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    labelingState.initialize();
    
    // í˜ì´ì§€ ë²—ì–´ë‚˜ê¸° ì „ ìë™ ì €ì¥
    window.addEventListener('beforeunload', async function(e) {
        // í˜„ì¬ ì‘ì—… ë‚´ìš©ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì €ì¥ ì‹œë„
        if (labelingState.selectedLabels.length > 0) {
            // ë™ê¸° ë°©ì‹ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì €ì¥ (beforeunloadì—ì„œëŠ” async ì‚¬ìš© ì œí•œ)
            try {
                navigator.sendBeacon('/api/labeling/save-label', JSON.stringify({
                    imageId: labelingState.currentImageId,
                    labels: labelingState.selectedLabels
                }));
            } catch (error) {
                console.log('Beacon ì €ì¥ ì‹¤íŒ¨, ë¡œì»¬ ìºì‹œ ìœ ì§€:', error);
            }
        }
    });
    
    // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ìë™ ì €ì¥
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && labelingState.selectedLabels.length > 0) {
            // í˜ì´ì§€ê°€ ìˆ¨ê²¨ì§ˆ ë•Œ ìë™ ì €ì¥
            labelingState.autoSaveToServer();
        }
    });
    
    // ì£¼ê¸°ì ìœ¼ë¡œ ì—°ê²° ìƒíƒœ í™•ì¸ ë° ë™ê¸°í™” (5ë¶„ë§ˆë‹¤)
    setInterval(async () => {
        if (navigator.onLine) {
            await labelingState.syncUnsavedData();
        }
    }, 300000);
});
</script>
{% endblock %}
